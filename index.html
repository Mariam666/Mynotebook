<!DOCTYPE html>
<html>
<head>
    <title>My Notebook</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: 'EB Garamond', 'Adobe Garamond Pro', 'Garamond', 'Times New Roman', serif; padding: 10px; background: #f9fafb; margin: 0; }
        .container { max-width: 1000px; margin: 0 auto; }
        h1 { color: #333; margin-bottom: 15px; font-size: 1.5rem; }
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-card { background: white; padding: 12px; border-radius: 8px; border: 2px solid #e5e7eb; text-align: center; cursor: pointer; font-size: 14px; }
        .stat-card:hover { background: #f3f4f6; }
        .nav-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px; }
        .tab-btn { padding: 12px 8px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; cursor: pointer; text-align: center; font-size: 12px; }
        .tab-btn:hover { background: #f3f4f6; }
        .tab-btn.active { background: #dbeafe; color: #1d4ed8; border-color: #93c5fd; }
        .content { background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; }
        .hidden { display: none; }
        input, textarea, select { padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; font-size: 14px; }
        textarea { width: 100%; height: 80px; resize: vertical; }
        .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: 14px; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-green { background: #10b981; color: white; }
        .btn-delete { background: #ef4444; color: white; padding: 4px 8px; font-size: 12px; }
        .item { padding: 12px; border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .item-content { flex: 1; cursor: pointer; font-size: 14px; }
        .item-actions { display: flex; gap: 6px; align-items: center; }
        .form-row { display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap; align-items: center; }
        .form-row input, .form-row select { min-width: 80px; flex: 1; }
        
        /* Enhanced table styles for calorie tracking */
        .calorie-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        .calorie-table th, .calorie-table td { 
            border: 1px solid #e5e7eb; 
            padding: 8px 12px; 
            text-align: center; 
            font-size: 14px;
        }
        .calorie-table th { 
            background: #f3f4f6; 
            font-weight: 600; 
            color: #374151;
        }
        .calorie-table tr:nth-child(even) { background: #f9fafb; }
        .calorie-table tr:hover { background: #f3f4f6; }
        .editable-cell { 
            cursor: pointer; 
            min-width: 80px;
            position: relative;
        }
        .editable-cell:hover { background: #e0f2fe; }
        .editing { background: #fff3cd !important; }
        .net-positive { color: #059669; font-weight: 600; }
        .net-negative { color: #dc2626; font-weight: 600; }
        .net-neutral { color: #6b7280; }
        
        .week-summary { 
            background: #f8fafc; 
            border: 2px solid #e2e8f0; 
            border-radius: 8px; 
            padding: 12px; 
            margin: 15px 0;
        }
        .week-header { 
            font-weight: 600; 
            color: #1e40af; 
            margin-bottom: 8px;
            font-size: 16px;
        }
        .week-stats { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
            gap: 8px;
        }
        .week-stat { 
            text-align: center; 
            padding: 6px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e5e7eb;
        }
        .week-stat-label { 
            font-size: 12px; 
            color: #6b7280; 
            margin-bottom: 2px;
        }
        .week-stat-value { 
            font-size: 14px; 
            font-weight: 600;
        }
        .progress-indicator { 
            font-size: 18px; 
            margin-left: 8px;
        }
        
        #paste-area img { max-width: 80px; max-height: 80px; object-fit: cover; border-radius: 4px; }
        
        @media (max-width: 768px) {
            body { padding: 8px; font-size: 16px; }
            .container { max-width: 100%; padding: 0; }
            h1 { font-size: 1.4rem; margin-bottom: 12px; text-align: center; font-weight: bold; }
            .stats { gap: 8px; margin-bottom: 16px; }
            .stat-card { padding: 16px; font-size: 14px; line-height: 1.3; min-height: 80px; }
            .nav-grid { gap: 6px; margin-bottom: 16px; }
            .tab-btn { padding: 20px 8px; font-size: 13px; line-height: 1.3; min-height: 70px; border-radius: 12px; }
            #home-button .tab-btn { padding: 24px; font-size: 16px; min-height: 80px; }
            .content { padding: 12px; }
            .item { padding: 12px; gap: 8px; margin-bottom: 8px; }
            .item-content { font-size: 14px; line-height: 1.4; }
            .form-row { gap: 8px; margin-bottom: 12px; flex-direction: column; align-items: stretch; }
            .form-row input, .form-row select { min-width: auto; font-size: 14px; width: 100%; margin-bottom: 6px; padding: 12px; box-sizing: border-box; }
            .btn { padding: 12px 16px; font-size: 14px; }
            .btn-delete { padding: 8px 12px; font-size: 12px; width: auto; }
            .form-row .btn { width: 100%; padding: 14px; }
            textarea { height: 80px; font-size: 14px; padding: 12px; }
            input, textarea, select { padding: 12px; font-size: 14px; border-radius: 8px; box-sizing: border-box; }
            h2 { font-size: 1.3rem; margin-bottom: 12px; }
            h3 { font-size: 1.1rem; margin-bottom: 8px; }
            
            /* Mobile table adjustments */
            .calorie-table { font-size: 12px; }
            .calorie-table th, .calorie-table td { padding: 6px 4px; }
            .week-stats { grid-template-columns: repeat(2, 1fr); }
            .week-stat { padding: 8px 4px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìù Notebook</h1>
        
        <div id="stats" class="stats">
            <div class="stat-card" onclick="showTab('calories')">
                <div>üî• Calories</div>
                <div style="font-size: 14px; color: #2563eb;" id="cal-today">0 cal today</div>
                <div style="font-size: 14px; color: #8b5cf6;" id="protein-today">0g protein</div>
                <div style="font-size: 14px; color: #f59e0b;" id="balance-today">Enter burned calories</div>
            </div>
            <div class="stat-card" onclick="showTab('spending')">
                <div>üí∞ Spending</div>
                <div style="font-size: 14px; color: #2563eb;" id="spend-week">$0 this week</div>
            </div>
        </div>
        
        <div id="home-button" style="margin-bottom: 15px;">
            <button class="tab-btn active" onclick="showTab('home')" id="tab-home" style="width: 100%; padding: 20px;">
                üè† Home
            </button>
        </div>
        
        <div class="nav-grid" id="nav-grid">
            <button class="tab-btn" onclick="showTab('notes')" id="tab-notes">üìù<br>Notes</button>
            <button class="tab-btn" onclick="showTab('read')" id="tab-read">üìö<br>Read</button>
            <button class="tab-btn" onclick="showTab('listen')" id="tab-listen">üéµ<br>Listen</button>
            <button class="tab-btn" onclick="showTab('watch')" id="tab-watch">üì∫<br>Watch</button>
            <button class="tab-btn" onclick="showTab('look')" id="tab-look">üëÅÔ∏è<br>Look</button>
            <button class="tab-btn" onclick="showTab('cook')" id="tab-cook">üç≥<br>Cook</button>
            <button class="tab-btn" onclick="showTab('make')" id="tab-make">üî®<br>Make</button>
            <button class="tab-btn" onclick="showTab('calories')" id="tab-calories">üî•<br>Calories</button>
            <button class="tab-btn" onclick="showTab('spending')" id="tab-spending">üí∞<br>Spending</button>
        </div>

        <div style="text-align: center; margin-bottom: 20px;">
            <button class="btn btn-green" onclick="downloadData()">üì• Download Data</button>
            <button class="btn" onclick="document.getElementById('upload').click()" style="background: #8b5cf6; color: white;">üì§ Upload Data</button>
            <input type="file" id="upload" accept=".json" style="display: none;" onchange="uploadData(event)">
        </div>
        
        <div id="content" class="content hidden"></div>
    </div>

<script>
let data = {
    lists: { read: [], listen: [], watch: [], cook: [], make: [], look: [] },
    notes: [],
    calories: [],
    caloriesBurned: [],
    spending: [],
    calorieTable: [] // New field for enhanced calorie tracking
};

function getPSTDate() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

function save() {
    try {
        localStorage.setItem('notebookData', JSON.stringify(data));
    } catch (e) {
        console.error('Save error:', e);
    }
}

function load() {
    try {
        const saved = localStorage.getItem('notebookData');
        if (saved) {
            const loadedData = JSON.parse(saved);
            data = { ...data, ...loadedData };
            // Ensure calorieTable exists for backwards compatibility
            if (!data.calorieTable) {
                data.calorieTable = [];
            }
        }
    } catch (e) {
        console.error('Load error:', e);
    }
}

function showTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    
    if (tab === 'home') {
        document.getElementById('stats').style.display = 'grid';
        document.getElementById('content').classList.add('hidden');
        document.getElementById('tab-home').classList.add('active');
        updateStats();
    } else {
        document.getElementById('stats').style.display = 'none';
        document.getElementById('content').classList.remove('hidden');
        document.getElementById('tab-' + tab).classList.add('active');
        loadTab(tab);
    }
}

function loadTab(tab) {
    const content = document.getElementById('content');
    
    if (['read', 'listen', 'watch', 'cook', 'make', 'look'].includes(tab)) {
        loadListTab(tab);
    } else if (tab === 'notes') {
        loadNotesTab();
    } else if (tab === 'calories') {
        loadCaloriesTab();
    } else if (tab === 'spending') {
        loadSpendingTab();
    }
}

function loadListTab(listName) {
    const items = data.lists[listName] || [];
    const content = document.getElementById('content');
    
    let html = '<h2>' + listName.toUpperCase() + '</h2>';
    
    if (listName === 'read') {
        html += '<div class="form-row">' +
                '<input type="text" id="item-input" placeholder="Title" style="flex: 2;">' +
                '<input type="url" id="link-input" placeholder="Link">' +
                '<select id="cat-input"><option value="book">Book</option><option value="essay">Essay</option><option value="poem">Poem</option></select>' +
                '<input type="date" id="date-input" value="' + getPSTDate() + '">' +
                '<button class="btn btn-primary" onclick="addItem(\'' + listName + '\')">Add</button>' +
                '</div>' +
                '<div style="margin: 8px 0;"><input type="text" id="search-' + listName + '" placeholder="üîç Search..." style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" oninput="simpleFilter(\'' + listName + '\')"></div>';
    } else {
        html += '<div class="form-row">' +
                '<input type="text" id="item-input" placeholder="Title" style="flex: 2;">' +
                '<input type="url" id="link-input" placeholder="Link">' +
                '<input type="date" id="date-input" value="' + getPSTDate() + '">' +
                '<button class="btn btn-primary" onclick="addItem(\'' + listName + '\')">Add</button>' +
                '</div>' +
                '<div style="margin: 8px 0;"><input type="text" id="search-' + listName + '" placeholder="üîç Search..." style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" oninput="simpleFilter(\'' + listName + '\')"></div>';
    }
    
    html += '<div>';
    items.sort((a, b) => b.date.localeCompare(a.date)).forEach(item => {
        let bgColor = 'white';
        if (listName === 'read') {
            if (item.category === 'book') bgColor = '#dbeafe';
            else if (item.category === 'essay') bgColor = '#f0fdf4';
            else if (item.category === 'poem') bgColor = '#faf5ff';
        }
        
        html += '<div class="item" style="background: ' + bgColor + ';">' +
                '<div class="item-content" onclick="editItem(\'' + listName + '\', ' + item.id + ')">' +
                item.content +
                (listName === 'read' ? '<br><small><strong>' + (item.category || 'book').toUpperCase() + '</strong></small>' : '') +
                '<br><small>' + item.date + '</small>' +
                '</div>' +
                '<div class="item-actions">' +
                (item.link ? '<button class="btn-green" style="padding: 4px 8px; font-size: 12px;" onclick="window.open(\'' + item.link + '\')">üîó</button>' : '') +
                '<button class="btn btn-delete" onclick="deleteItem(\'' + listName + '\', ' + item.id + ')">üóëÔ∏è</button>' +
                '</div>' +
                '</div>';
    });
    html += '</div></div>';
    
    content.innerHTML = html;
}

function addItem(listName) {
    const itemInput = document.getElementById('item-input');
    const linkInput = document.getElementById('link-input');
    const dateInput = document.getElementById('date-input');
    
    if (!itemInput.value.trim() || !dateInput.value) return;
    
    const item = {
        id: Date.now(),
        content: itemInput.value.trim(),
        date: dateInput.value
    };
    
    if (listName === 'read') {
        item.category = document.getElementById('cat-input').value;
    }
    
    if (linkInput.value.trim()) {
        item.link = linkInput.value.trim();
    }
    
    data.lists[listName].push(item);
    save();
    itemInput.value = '';
    linkInput.value = '';
    loadListTab(listName);
}

function editItem(listName, id) {
    const item = data.lists[listName].find(i => i.id === id);
    if (!item) return;
    
    const newContent = prompt('Edit:', item.content);
    if (!newContent) return;
    
    const newDate = prompt('Date (YYYY-MM-DD):', item.date);
    if (!newDate) return;
    
    item.content = newContent;
    item.date = newDate;
    
    if (listName === 'read') {
        const newCategory = prompt('Category (book/essay/poem):', item.category || 'book');
        if (newCategory) item.category = newCategory;
    }
    
    save();
    loadListTab(listName);
}

function deleteItem(listName, id) {
    if (!confirm('Delete this item?')) return;
    data.lists[listName] = data.lists[listName].filter(i => i.id !== id);
    save();
    loadListTab(listName);
}

function simpleFilter(listName) {
    const query = document.getElementById('search-' + listName).value.toLowerCase();
    document.querySelectorAll('.item').forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(query) ? 'flex' : 'none';
    });
}

function loadNotesTab() {
    const content = document.getElementById('content');
    let html = '<h2>NOTES</h2>';
    
    html += '<div class="form-row">' +
            '<textarea id="note-input" placeholder="Write your note..." style="flex: 1; min-height: 80px;"></textarea>' +
            '<button class="btn btn-primary" onclick="addNote()" style="align-self: flex-start;">Add Note</button>' +
            '</div>';
    
    html += '<div id="paste-area" style="border: 2px dashed #ccc; padding: 15px; margin: 10px 0; text-align: center; cursor: pointer;" onclick="document.getElementById(\'file-input\').click()">' +
            'Click to upload image or drag & drop' +
            '<input type="file" id="file-input" accept="image/*" style="display: none;" onchange="handleFileUpload(event)">' +
            '</div>';
    
    html += '<div>';
    data.notes.sort((a, b) => b.date.localeCompare(a.date)).forEach(note => {
        html += '<div class="item">' +
                '<div class="item-content" onclick="editNote(' + note.id + ')">' +
                (note.image ? '<img src="' + note.image + '" style="max-width: 100px; max-height: 100px; float: right; margin-left: 10px; border-radius: 4px;">' : '') +
                note.content.replace(/\n/g, '<br>') +
                '<br><small>' + note.date + '</small>' +
                '</div>' +
                '<div class="item-actions">' +
                '<button class="btn btn-delete" onclick="deleteNote(' + note.id + ')">üóëÔ∏è</button>' +
                '</div>' +
                '</div>';
    });
    html += '</div>';
    
    content.innerHTML = html;
}

function addNote() {
    const input = document.getElementById('note-input');
    if (!input.value.trim()) return;
    
    const note = {
        id: Date.now(),
        content: input.value.trim(),
        date: getPSTDate()
    };
    
    data.notes.push(note);
    save();
    input.value = '';
    loadNotesTab();
}

function editNote(id) {
    const note = data.notes.find(n => n.id === id);
    if (!note) return;
    
    const newContent = prompt('Edit note:', note.content);
    if (newContent !== null) {
        note.content = newContent;
        save();
        loadNotesTab();
    }
}

function deleteNote(id) {
    if (!confirm('Delete this note?')) return;
    data.notes = data.notes.filter(n => n.id !== id);
    save();
    loadNotesTab();
}

function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const pasteArea = document.getElementById('paste-area');
        pasteArea.innerHTML += '<img src="' + e.target.result + '" style="max-width: 80px; max-height: 80px; margin: 5px; border-radius: 4px;">';
        
        // Add note with image
        const note = {
            id: Date.now(),
            content: 'Image uploaded',
            image: e.target.result,
            date: getPSTDate()
        };
        data.notes.push(note);
        save();
        loadNotesTab();
    };
    reader.readAsDataURL(file);
}

// Enhanced calorie tracking functions
function loadCaloriesTab() {
    const content = document.getElementById('content');
    let html = '<h2>üî• CALORIES</h2>';
    
    // Individual meal tracking
    html += '<div style="margin-bottom: 20px; padding: 15px; background: #f0fdf4; border-radius: 8px;">' +
            '<h3>üçΩÔ∏è Add Individual Meals</h3>' +
            '<div class="form-row">' +
            '<input type="text" id="meal-desc" placeholder="Meal description (e.g. Breakfast, chicken salad)" style="flex: 2;">' +
            '<input type="number" id="meal-calories" placeholder="Calories" style="flex: 1;">' +
            '<input type="number" id="meal-protein" placeholder="Protein (g)" style="flex: 1;">' +
            '<input type="date" id="meal-date" value="' + getPSTDate() + '">' +
            '<button class="btn btn-primary" onclick="addMeal()">Add Meal</button>' +
            '</div>' +
            '</div>' +
            
            // Show meal list
            '<div style="margin-bottom: 20px;">' +
            '<h3>üìù Recent Meals</h3>' +
            '<div id="meals-list"></div>' +
            '</div>' +
            
            // Exercise tracking
            '<div style="margin-bottom: 20px; padding: 15px; background: #fef3c7; border-radius: 8px;">' +
            '<h3>üèÉ Add Exercise/Burned Calories</h3>' +
            '<div class="form-row">' +
            '<input type="text" id="exercise-desc" placeholder="Exercise description" style="flex: 2;">' +
            '<input type="number" id="exercise-calories" placeholder="Calories burned" style="flex: 1;">' +
            '<input type="date" id="exercise-date" value="' + getPSTDate() + '">' +
            '<button class="btn btn-green" onclick="addExercise()">Add Exercise</button>' +
            '</div>' +
            '</div>' +
            
            // Show exercise list
            '<div style="margin-bottom: 20px;">' +
            '<h3>üí™ Recent Exercise</h3>' +
            '<div id="exercise-list"></div>' +
            '</div>';
    
    // Enhanced calorie table
    html += '<div style="margin-bottom: 20px;">' +
            '<h3>Calorie Tracking Table</h3>' +
            '<div style="margin-bottom: 10px;">' +
            '<button class="btn btn-primary" onclick="addTableRow()">‚ûï Add Day</button>' +
            '<button class="btn" onclick="fillMissingDays()" style="background: #8b5cf6; color: white; margin-left: 8px;">üìÖ Fill Missing Days</button>' +
            '</div>' +
            '<div style="overflow-x: auto;">' +
            '<table class="calorie-table">' +
            '<thead>' +
            '<tr>' +
            '<th>Date</th>' +
            '<th>Calories In</th>' +
            '<th>Calories Out</th>' +
            '<th>Net (Out-In)</th>' +
            '<th>Actions</th>' +
            '</tr>' +
            '</thead>' +
            '<tbody id="calorie-table-body">' +
            '</tbody>' +
            '</table>' +
            '</div>' +
            '</div>';
    
    content.innerHTML = html;
    
    // Populate table and lists
    populateCalorieTable();
    populateMealsList();
    populateExerciseList();
    generateWeeklyAnalysis();
}

function addMeal() {
    const descInput = document.getElementById('meal-desc');
    const caloriesInput = document.getElementById('meal-calories');
    const proteinInput = document.getElementById('meal-protein');
    const dateInput = document.getElementById('meal-date');
    
    if (!descInput.value.trim() || !caloriesInput.value || !dateInput.value) return;
    
    const meal = {
        id: Date.now(),
        description: descInput.value.trim(),
        amount: parseInt(caloriesInput.value),
        protein: parseInt(proteinInput.value) || 0,
        date: dateInput.value
    };
    
    // Add to calories array for legacy compatibility
    data.calories.push(meal);
    
    // Also update the calorie table
    let tableRow = data.calorieTable.find(r => r.date === dateInput.value);
    if (!tableRow) {
        tableRow = { date: dateInput.value, caloriesIn: 0, caloriesOut: 0 };
        data.calorieTable.push(tableRow);
    }
    tableRow.caloriesIn += meal.amount;
    
    save();
    descInput.value = '';
    caloriesInput.value = '';
    proteinInput.value = '';
    
    populateMealsList();
    populateCalorieTable();
    generateWeeklyAnalysis();
    updateStats();
}

function addExercise() {
    const descInput = document.getElementById('exercise-desc');
    const caloriesInput = document.getElementById('exercise-calories');
    const dateInput = document.getElementById('exercise-date');
    
    if (!descInput.value.trim() || !caloriesInput.value || !dateInput.value) return;
    
    const exercise = {
        id: Date.now(),
        description: descInput.value.trim(),
        amount: parseInt(caloriesInput.value),
        date: dateInput.value
    };
    
    // Add to burned calories array
    data.caloriesBurned.push(exercise);
    
    // Also update the calorie table
    let tableRow = data.calorieTable.find(r => r.date === dateInput.value);
    if (!tableRow) {
        tableRow = { date: dateInput.value, caloriesIn: 0, caloriesOut: 0 };
        data.calorieTable.push(tableRow);
    }
    tableRow.caloriesOut += exercise.amount;
    
    save();
    descInput.value = '';
    caloriesInput.value = '';
    
    populateExerciseList();
    populateCalorieTable();
    generateWeeklyAnalysis();
    updateStats();
}

function populateMealsList() {
    const container = document.getElementById('meals-list');
    if (!container) return;
    
    const recentMeals = data.calories.slice(-10).reverse(); // Show last 10 meals
    
    let html = '';
    recentMeals.forEach(meal => {
        html += '<div class="item">' +
                '<div class="item-content">' +
                '<strong>' + meal.description + '</strong> - ' + meal.amount + ' cal, ' + (meal.protein || 0) + 'g protein' +
                '<br><small>' + meal.date + '</small>' +
                '</div>' +
                '<div class="item-actions">' +
                '<button class="btn btn-delete" onclick="deleteMeal(' + meal.id + ')">üóëÔ∏è</button>' +
                '</div>' +
                '</div>';
    });
    
    container.innerHTML = html;
}

function populateExerciseList() {
    const container = document.getElementById('exercise-list');
    if (!container) return;
    
    const recentExercise = data.caloriesBurned.slice(-10).reverse(); // Show last 10 exercises
    
    let html = '';
    recentExercise.forEach(exercise => {
        html += '<div class="item">' +
                '<div class="item-content">' +
                '<strong>' + exercise.description + '</strong> - ' + exercise.amount + ' cal burned' +
                '<br><small>' + exercise.date + '</small>' +
                '</div>' +
                '<div class="item-actions">' +
                '<button class="btn btn-delete" onclick="deleteExercise(' + exercise.id + ')">üóëÔ∏è</button>' +
                '</div>' +
                '</div>';
    });
    
    container.innerHTML = html;
}

function deleteMeal(id) {
    if (!confirm('Delete this meal?')) return;
    
    // Find and remove the meal
    const mealIndex = data.calories.findIndex(m => m.id === id);
    if (mealIndex !== -1) {
        const meal = data.calories[mealIndex];
        data.calories.splice(mealIndex, 1);
        
        // Update calorie table
        const tableRow = data.calorieTable.find(r => r.date === meal.date);
        if (tableRow) {
            tableRow.caloriesIn = Math.max(0, tableRow.caloriesIn - meal.amount);
        }
        
        save();
        populateMealsList();
        populateCalorieTable();
        generateWeeklyAnalysis();
        updateStats();
    }
}

function deleteExercise(id) {
    if (!confirm('Delete this exercise?')) return;
    
    // Find and remove the exercise
    const exerciseIndex = data.caloriesBurned.findIndex(e => e.id === id);
    if (exerciseIndex !== -1) {
        const exercise = data.caloriesBurned[exerciseIndex];
        data.caloriesBurned.splice(exerciseIndex, 1);
        
        // Update calorie table
        const tableRow = data.calorieTable.find(r => r.date === exercise.date);
        if (tableRow) {
            tableRow.caloriesOut = Math.max(0, tableRow.caloriesOut - exercise.amount);
        }
        
        save();
        populateExerciseList();
        populateCalorieTable();
        generateWeeklyAnalysis();
        updateStats();
    }
}

function populateCalorieTable() {
    const tbody = document.getElementById('calorie-table-body');
    if (!tbody) return;
    
    // Sort by date descending
    const sortedData = [...data.calorieTable].sort((a, b) => b.date.localeCompare(a.date));
    
    let html = '';
    sortedData.forEach(row => {
        const net = (row.caloriesOut || 0) - (row.caloriesIn || 0);
        const netClass = net > 0 ? 'net-positive' : net < 0 ? 'net-negative' : 'net-neutral';
        
        html += '<tr>' +
                '<td>' + row.date + '</td>' +
                '<td class="editable-cell" onclick="editCell(this, \'' + row.date + '\', \'caloriesIn\')">' + (row.caloriesIn || 0) + '</td>' +
                '<td class="editable-cell" onclick="editCell(this, \'' + row.date + '\', \'caloriesOut\')">' + (row.caloriesOut || 0) + '</td>' +
                '<td class="' + netClass + '">' + net + '</td>' +
                '<td><button class="btn btn-delete" onclick="deleteTableRow(\'' + row.date + '\')">üóëÔ∏è</button></td>' +
                '</tr>';
    });
    
    tbody.innerHTML = html;
}

function addTableRow() {
    const date = prompt('Enter date (YYYY-MM-DD):', getPSTDate());
    if (!date) return;
    
    // Check if date already exists
    const existingRow = data.calorieTable.find(row => row.date === date);
    if (existingRow) {
        alert('Date already exists in table');
        return;
    }
    
    data.calorieTable.push({
        date: date,
        caloriesIn: 0,
        caloriesOut: 0
    });
    
    save();
    populateCalorieTable();
    generateWeeklyAnalysis();
}

function deleteTableRow(date) {
    if (!confirm('Delete this day\'s data?')) return;
    
    data.calorieTable = data.calorieTable.filter(row => row.date !== date);
    save();
    populateCalorieTable();
    generateWeeklyAnalysis();
}

function editCell(cell, date, field) {
    const currentValue = cell.textContent;
    cell.classList.add('editing');
    
    const input = document.createElement('input');
    input.type = 'number';
    input.value = currentValue;
    input.style.width = '100%';
    input.style.border = 'none';
    input.style.background = 'transparent';
    input.style.textAlign = 'center';
    
    cell.innerHTML = '';
    cell.appendChild(input);
    input.focus();
    input.select();
    
    function saveEdit() {
        const newValue = parseInt(input.value) || 0;
        const row = data.calorieTable.find(r => r.date === date);
        if (row) {
            row[field] = newValue;
            save();
            populateCalorieTable();
            generateWeeklyAnalysis();
        }
    }
    
    input.addEventListener('blur', saveEdit);
    input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            saveEdit();
        }
    });
}

function fillMissingDays() {
    const today = new Date();
    const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
    
    const existingDates = new Set(data.calorieTable.map(row => row.date));
    
    for (let d = new Date(thirtyDaysAgo); d <= today; d.setDate(d.getDate() + 1)) {
        const dateStr = d.getFullYear() + '-' + 
                       String(d.getMonth() + 1).padStart(2, '0') + '-' + 
                       String(d.getDate()).padStart(2, '0');
        
        if (!existingDates.has(dateStr)) {
            data.calorieTable.push({
                date: dateStr,
                caloriesIn: 0,
                caloriesOut: 0
            });
        }
    }
    
    save();
    populateCalorieTable();
    generateWeeklyAnalysis();
}

function generateWeeklyAnalysis() {
    const content = document.getElementById('content');
    const existingAnalysis = document.getElementById('weekly-analysis');
    if (existingAnalysis) {
        existingAnalysis.remove();
    }
    
    // Group data by week
    const weeks = {};
    data.calorieTable.forEach(row => {
        const date = new Date(row.date);
        const weekStart = getWeekStart(date);
        const weekKey = weekStart.toISOString().split('T')[0];
        
        if (!weeks[weekKey]) {
            weeks[weekKey] = {
                start: weekStart,
                days: [],
                totalIn: 0,
                totalOut: 0,
                totalNet: 0
            };
        }
        
        weeks[weekKey].days.push(row);
        weeks[weekKey].totalIn += row.caloriesIn || 0;
        weeks[weekKey].totalOut += row.caloriesOut || 0;
        weeks[weekKey].totalNet += (row.caloriesOut || 0) - (row.caloriesIn || 0);
    });
    
    // Sort weeks by start date (most recent first)
    const sortedWeeks = Object.entries(weeks).sort((a, b) => b[1].start.getTime() - a[1].start.getTime());
    
    let analysisHtml = '<div id="weekly-analysis"><h3>üìä Weekly Analysis</h3>';
    
    sortedWeeks.slice(0, 8).forEach(([weekKey, week], index) => {
        const weekEnd = new Date(week.start);
        weekEnd.setDate(weekEnd.getDate() + 6);
        
        // Compare with previous week for progress indicator
        let progressIndicator = '';
        if (index < sortedWeeks.length - 1) {
            const prevWeek = sortedWeeks[index + 1][1];
            if (week.totalNet > prevWeek.totalNet) {
                progressIndicator = '<span class="progress-indicator">üìà</span>';
            } else if (week.totalNet < prevWeek.totalNet) {
                progressIndicator = '<span class="progress-indicator">üìâ</span>';
            } else {
                progressIndicator = '<span class="progress-indicator">‚û°Ô∏è</span>';
            }
        }
        
        analysisHtml += '<div class="week-summary">' +
                       '<div class="week-header">' +
                       'Week of ' + formatDate(week.start) + ' - ' + formatDate(weekEnd) +
                       progressIndicator +
                       '</div>' +
                       '<div class="week-stats">' +
                       '<div class="week-stat">' +
                       '<div class="week-stat-label">Total In</div>' +
                       '<div class="week-stat-value" style="color: #dc2626;">' + week.totalIn + '</div>' +
                       '</div>' +
                       '<div class="week-stat">' +
                       '<div class="week-stat-label">Total Out</div>' +
                       '<div class="week-stat-value" style="color: #059669;">' + week.totalOut + '</div>' +
                       '</div>' +
                       '<div class="week-stat">' +
                       '<div class="week-stat-label">Net Total</div>' +
                       '<div class="week-stat-value ' + (week.totalNet > 0 ? 'net-positive' : week.totalNet < 0 ? 'net-negative' : 'net-neutral') + '">' + week.totalNet + '</div>' +
                       '</div>' +
                       '</div>' +
                       '</div>';
    });
    
    analysisHtml += '</div>';
    
    content.innerHTML += analysisHtml;
}

function getWeekStart(date) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = d.getDate() - day;
    return new Date(d.setDate(diff));
}

function formatDate(date) {
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}



// Legacy calorie functions for backwards compatibility
function addCalorie() {
    const dateInput = document.getElementById('cal-date');
    const calInput = document.getElementById('cal-input');
    const proteinInput = document.getElementById('protein-input');
    
    if (!calInput.value || !dateInput.value) return;
    
    const calories = parseInt(calInput.value);
    const protein = parseInt(proteinInput.value) || 0;
    const date = dateInput.value;
    
    // Add to legacy calories array
    data.calories.push({
        id: Date.now(),
        amount: calories,
        protein: protein,
        date: date
    });
    
    // Update or add to calorie table
    let tableRow = data.calorieTable.find(r => r.date === date);
    if (!tableRow) {
        tableRow = { date: date, caloriesIn: 0, caloriesOut: 0 };
        data.calorieTable.push(tableRow);
    }
    tableRow.caloriesIn += calories;
    
    save();
    calInput.value = '';
    proteinInput.value = '';
    populateCalorieTable();
    generateWeeklyAnalysis();
    updateStats();
}

function addBurnedCalorie() {
    const dateInput = document.getElementById('burned-date');
    const burnInput = document.getElementById('burned-input');
    
    if (!burnInput.value || !dateInput.value) return;
    
    const burned = parseInt(burnInput.value);
    const date = dateInput.value;
    
    // Add to legacy burned array
    data.caloriesBurned.push({
        id: Date.now(),
        amount: burned,
        date: date
    });
    
    // Update or add to calorie table
    let tableRow = data.calorieTable.find(r => r.date === date);
    if (!tableRow) {
        tableRow = { date: date, caloriesIn: 0, caloriesOut: 0 };
        data.calorieTable.push(tableRow);
    }
    tableRow.caloriesOut += burned;
    
    save();
    burnInput.value = '';
    populateCalorieTable();
    generateWeeklyAnalysis();
    updateStats();
}

function loadSpendingTab() {
    const content = document.getElementById('content');
    let html = '<h2>üí∞ SPENDING</h2>';
    
    html += '<div class="form-row">' +
            '<input type="date" id="spend-date" value="' + getPSTDate() + '">' +
            '<input type="number" id="spend-input" placeholder="Amount" step="0.01" style="flex: 1;">' +
            '<input type="text" id="spend-desc" placeholder="Description" style="flex: 2;">' +
            '<button class="btn btn-primary" onclick="addSpending()">Add</button>' +
            '</div>';
    
    html += '<div>';
    data.spending.sort((a, b) => b.date.localeCompare(a.date)).forEach(item => {
        html += '<div class="item">' +
                '<div class="item-content" onclick="editSpending(' + item.id + ')">' +
                '$' + item.amount.toFixed(2) + ' - ' + item.description +
                '<br><small>' + item.date + '</small>' +
                '</div>' +
                '<div class="item-actions">' +
                '<button class="btn btn-delete" onclick="deleteSpending(' + item.id + ')">üóëÔ∏è</button>' +
                '</div>' +
                '</div>';
    });
    html += '</div>';
    
    content.innerHTML = html;
}

function addSpending() {
    const dateInput = document.getElementById('spend-date');
    const amountInput = document.getElementById('spend-input');
    const descInput = document.getElementById('spend-desc');
    
    if (!amountInput.value || !dateInput.value || !descInput.value.trim()) return;
    
    data.spending.push({
        id: Date.now(),
        amount: parseFloat(amountInput.value),
        description: descInput.value.trim(),
        date: dateInput.value
    });
    
    save();
    amountInput.value = '';
    descInput.value = '';
    loadSpendingTab();
    updateStats();
}

function editSpending(id) {
    const item = data.spending.find(s => s.id === id);
    if (!item) return;
    
    const newAmount = prompt('Amount:', item.amount);
    if (!newAmount) return;
    
    const newDesc = prompt('Description:', item.description);
    if (!newDesc) return;
    
    const newDate = prompt('Date (YYYY-MM-DD):', item.date);
    if (!newDate) return;
    
    item.amount = parseFloat(newAmount);
    item.description = newDesc;
    item.date = newDate;
    
    save();
    loadSpendingTab();
    updateStats();
}

function deleteSpending(id) {
    if (!confirm('Delete this spending entry?')) return;
    data.spending = data.spending.filter(s => s.id !== id);
    save();
    loadSpendingTab();
    updateStats();
}

function updateStats() {
    const today = getPSTDate();
    
    // Calculate today's calories and protein from legacy data
    const todayCalories = data.calories ? data.calories.filter(c => c.date === today).reduce((sum, c) => sum + (c.amount || 0), 0) : 0;
    const todayProtein = data.calories ? data.calories.filter(c => c.date === today).reduce((sum, c) => sum + (c.protein || 0), 0) : 0;
    const todayBurned = data.caloriesBurned ? data.caloriesBurned.filter(c => c.date === today).reduce((sum, c) => sum + (c.amount || 0), 0) : 0;
    
    // Also check calorie table data
    const tableToday = data.calorieTable ? data.calorieTable.find(r => r.date === today) : null;
    const tableCaloriesIn = tableToday ? (tableToday.caloriesIn || 0) : 0;
    const tableCaloriesOut = tableToday ? (tableToday.caloriesOut || 0) : 0;
    
    // Use the higher values between legacy and table data
    const totalCaloriesIn = Math.max(todayCalories || 0, tableCaloriesIn || 0);
    const totalCaloriesOut = Math.max(todayBurned || 0, tableCaloriesOut || 0);
    
    document.getElementById('cal-today').textContent = totalCaloriesIn + ' cal today';
    document.getElementById('protein-today').textContent = todayProtein + 'g protein';
    
    const balance = totalCaloriesOut - totalCaloriesIn;
    const balanceElement = document.getElementById('balance-today');
    
    let balanceText, balanceColor;
    if (balance > 100) {
        balanceText = `-${balance} cal deficit`;
        balanceColor = '#059669'; // Green for deficit
    } else if (balance >= -100 && balance <= 100) {
        balanceText = balance === 0 ? 'Balanced calories' : `${balance > 0 ? '-' : '+'}${Math.abs(balance)} cal maintenance`;
        balanceColor = '#f59e0b'; // Orange for maintenance
    } else {
        balanceText = `+${Math.abs(balance)} cal surplus`;
        balanceColor = '#dc2626'; // Red for surplus
    }
    
    balanceElement.textContent = balanceText;
    balanceElement.style.color = balanceColor;
    
    // This week's spending
    const weekAgo = new Date();
    weekAgo.setDate(weekAgo.getDate() - 7);
    const weekAgoStr = weekAgo.getFullYear() + '-' + 
                      String(weekAgo.getMonth() + 1).padStart(2, '0') + '-' + 
                      String(weekAgo.getDate()).padStart(2, '0');
    
    const weekSpend = data.spending ? data.spending.filter(s => s.date >= weekAgoStr).reduce((sum, s) => sum + (s.amount || 0), 0) : 0;
    document.getElementById('spend-week').textContent = '$' + weekSpend.toFixed(2) + ' this week';
}

function downloadData() {
    // Create a clean export with all current data structures
    const exportData = {
        version: "2.0", // Version to help with future compatibility
        exportDate: getPSTDate(),
        lists: data.lists || { read: [], listen: [], watch: [], cook: [], make: [], look: [] },
        notes: data.notes || [],
        calories: data.calories || [], // Individual meals
        caloriesBurned: data.caloriesBurned || [], // Individual exercises
        spending: data.spending || [],
        calorieTable: data.calorieTable || [] // Daily summary table
    };
    
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'notebook-data-' + getPSTDate() + '.json';
    link.click();
    URL.revokeObjectURL(url);
    
    console.log('Data exported with structure:', Object.keys(exportData));
}

function uploadData(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            
            if (confirm('This will replace all current data. Continue?')) {
                // Handle both old and new data formats
                const newData = {
                    lists: importedData.lists || { read: [], listen: [], watch: [], cook: [], make: [], look: [] },
                    notes: importedData.notes || [],
                    calories: importedData.calories || [],
                    caloriesBurned: importedData.caloriesBurned || [],
                    spending: importedData.spending || [],
                    calorieTable: importedData.calorieTable || []
                };
                
                // If importing old format without calorieTable, try to rebuild it from individual entries
                if (!importedData.calorieTable && (importedData.calories || importedData.caloriesBurned)) {
                    console.log('Converting old format to new format...');
                    newData.calorieTable = rebuildCalorieTable(newData.calories, newData.caloriesBurned);
                }
                
                data = newData;
                save();
                
                // Refresh all UI components
                updateStats();
                populateCalorieTable();
                generateWeeklyAnalysis();
                
                const version = importedData.version || "1.0";
                alert(`Data imported successfully! (Format version: ${version})`);
                showTab('home');
            }
        } catch (error) {
            alert('Error importing data: ' + error.message);
            console.error('Import error:', error);
        }
    };
    reader.readAsText(file);
}

function rebuildCalorieTable(calories, caloriesBurned) {
    const table = [];
    const dateMap = {};
    
    // Process calories (meals)
    if (calories) {
        calories.forEach(meal => {
            if (!dateMap[meal.date]) {
                dateMap[meal.date] = { date: meal.date, caloriesIn: 0, caloriesOut: 0 };
            }
            dateMap[meal.date].caloriesIn += meal.amount || 0;
        });
    }
    
    // Process burned calories (exercises)
    if (caloriesBurned) {
        caloriesBurned.forEach(exercise => {
            if (!dateMap[exercise.date]) {
                dateMap[exercise.date] = { date: exercise.date, caloriesIn: 0, caloriesOut: 0 };
            }
            dateMap[exercise.date].caloriesOut += exercise.amount || 0;
        });
    }
    
    // Convert to array
    Object.values(dateMap).forEach(day => table.push(day));
    
    console.log('Rebuilt calorie table with', table.length, 'days');
    return table;
}

// Initialize app
load();
updateStats();
showTab('home');

</script>
</body>
</html>
