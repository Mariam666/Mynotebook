<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>My Notebook v3.0</title>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'EB Garamond', 'Adobe Garamond Pro', 'Garamond', 'Times New Roman', serif;
            padding: 10px;
            background: #f9fafb;
            margin: 0;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        h1 { color: #333; margin-bottom: 15px; font-size: 1.5rem; }
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-card {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
            text-align: center;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .stat-card:hover { background: #f3f4f6; }
        .nav-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px; }
        .tab-btn {
            padding: 12px 8px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-size: 12px;
            transition: all 0.2s;
        }
        .tab-btn:hover { background: #f3f4f6; }
        .tab-btn.active { background: #dbeafe; color: #1d4ed8; border-color: #93c5fd; }
        .content { background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; }
        .hidden { display: none; }
        input, textarea, select {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            font-size: 14px;
        }
        textarea { width: 100%; height: 80px; resize: vertical; box-sizing: border-box; }
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: opacity 0.2s;
        }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-green { background: #10b981; color: white; }
        .btn-delete, button.btn-delete {
            background: #3b82f6 !important;
            color: white !important;
            padding: 4px 8px;
            font-size: 12px;
            border: none !important;
            border-radius: 4px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .btn-delete:hover, button.btn-delete:hover {
            opacity: 0.9;
        }
        .item {
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
        }
        .item-content { flex: 1; cursor: pointer; font-size: 14px; }
        .item-actions { display: flex; gap: 6px; align-items: center; }
        .form-row {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
            flex-wrap: wrap;
            align-items: center;
        }
        .form-row input, .form-row select { min-width: 80px; flex: 1; }

        /* Enhanced table styles for calorie tracking */
        .calorie-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        .calorie-table th, .calorie-table td {
            border: 1px solid #e5e7eb;
            padding: 8px 12px;
            text-align: center;
            font-size: 14px;
        }
        .calorie-table th {
            background: #f3f4f6;
            font-weight: 600;
            color: #374151;
        }
        .calorie-table tr:nth-child(even) { background: #f9fafb; }
        .calorie-table tr:hover { background: #f3f4f6; }
        .editable-cell {
            cursor: pointer;
            min-width: 80px;
            position: relative;
        }
        .editable-cell:hover { background: #e0f2fe; }
        .editing { background: #fff3cd !important; }
        .net-positive { color: #dc2626; font-weight: 600; }
        .net-negative { color: #059669; font-weight: 600; }
        .net-neutral { color: #6b7280; }
        .consumed-cell { color: #059669; font-weight: 600; }
        .burned-cell { color: #dc2626; font-weight: 600; }
        .protein-cell { color: #8b5cf6; font-weight: 600; }

        .spending-category {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            padding: 8px;
            border-radius: 4px;
            margin: 4px 0;
        }
        .spending-category-header {
            font-weight: 600;
            color: #0369a1;
            margin-bottom: 4px;
        }

        .week-summary {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            margin: 15px 0;
        }
        .week-header {
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 8px;
            font-size: 16px;
        }
        .week-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
        }
        .week-stat {
            text-align: center;
            padding: 6px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e5e7eb;
        }
        .week-stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 2px;
        }
        .week-stat-value {
            font-size: 14px;
            font-weight: 600;
        }
        .progress-indicator {
            font-size: 18px;
            margin-left: 8px;
        }

        .spending-category {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            padding: 8px;
            border-radius: 4px;
            margin: 4px 0;
        }
        .spending-category-header {
            font-weight: 600;
            color: #0369a1;
            margin-bottom: 4px;
        }

        .note-item {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        .note-date {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }
        .note-content {
            white-space: pre-wrap;
            line-height: 1.6;
        }
        .note-content ul {
            margin: 8px 0;
            padding-left: 20px;
        }
        .note-content li {
            margin: 4px 0;
        }
        .note-content .indent-1 { padding-left: 20px; }
        .note-content .indent-2 { padding-left: 40px; }
        .note-content .indent-3 { padding-left: 60px; }
        .editable-text { cursor: pointer; }
        .editable-text:hover { background: #e0f2fe; padding: 1px 3px; border-radius: 3px; }

        /* Spending filter controls */
        .filter-controls {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
        }
        .filter-row {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }
        .filter-row:last-child {
            margin-bottom: 0;
        }
        .filter-label {
            font-weight: 600;
            color: #374151;
            min-width: 80px;
            font-size: 14px;
        }
        .filter-input {
            flex: 1;
            min-width: 120px;
        }

        @media (max-width: 768px) {
            body { padding: 8px; font-size: 16px; }
            .container { max-width: 100%; padding: 0; }
            h1 { font-size: 1.4rem; margin-bottom: 12px; text-align: center; font-weight: bold; }
            .stats { gap: 8px; margin-bottom: 16px; }
            .stat-card { padding: 16px; font-size: 14px; line-height: 1.3; min-height: 80px; }
            .nav-grid { gap: 6px; margin-bottom: 16px; }
            .tab-btn { padding: 20px 8px; font-size: 13px; line-height: 1.3; min-height: 70px; border-radius: 12px; }
            #home-button .tab-btn { padding: 24px; font-size: 16px; min-height: 80px; }
            .content { padding: 12px; }
            .item { padding: 12px; gap: 8px; margin-bottom: 8px; }
            .item-content { font-size: 14px; line-height: 1.4; }
            .form-row { gap: 8px; margin-bottom: 12px; flex-direction: column; align-items: stretch; }
            .form-row input, .form-row select {
                min-width: auto;
                font-size: 14px;
                width: 100%;
                margin-bottom: 6px;
                padding: 12px;
                box-sizing: border-box;
            }
            .btn { padding: 12px 16px; font-size: 14px; }
            .btn-delete { padding: 8px 12px; font-size: 12px; width: auto; }
            .form-row .btn { width: 100%; padding: 14px; }
            textarea { height: 80px; font-size: 14px; padding: 12px; }
            input, textarea, select { padding: 12px; font-size: 14px; border-radius: 8px; box-sizing: border-box; }
            h2 { font-size: 1.3rem; margin-bottom: 12px; }
            h3 { font-size: 1.1rem; margin-bottom: 8px; }

            /* Mobile table adjustments */
            .calorie-table { font-size: 12px; }
            .calorie-table th, .calorie-table td { padding: 6px 4px; }
            .week-stats { grid-template-columns: repeat(2, 1fr); }
            .week-stat { padding: 8px 4px; }

            /* Mobile filter controls */
            .filter-row {
                flex-direction: column;
                align-items: stretch;
            }
            .filter-label {
                min-width: auto;
                margin-bottom: 4px;
            }
            .filter-input {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìù Notebook</h1>

        <div id="stats" class="stats">
            <div class="stat-card" onclick="showTab('calories')">
                <div>üî• Calories</div>
                <div style="font-size: 14px; color: #2563eb;" id="cal-today">0 cal today</div>
                <div style="font-size: 14px; color: #8b5cf6;" id="protein-today">0g protein</div>
                <div style="font-size: 14px; color: #f59e0b;" id="balance-today">Enter burned calories</div>
            </div>
            <div class="stat-card" onclick="showTab('spending')">
                <div>üí∞ Spending</div>
                <div style="font-size: 14px; color: #dc2626;" id="spend-today">$0 today</div>
                <div style="font-size: 14px; color: #2563eb;" id="spend-week">$0 this week</div>
                <div style="font-size: 14px; color: #8b5cf6;" id="spend-month">$0 this month</div>
            </div>
        </div>

        <div id="home-button" style="margin-bottom: 15px;">
            <button class="tab-btn active" onclick="showTab('home')" id="tab-home" style="width: 100%; padding: 20px;">
                üè† Home
            </button>
        </div>

        <div class="nav-grid" id="nav-grid">
            <button class="tab-btn" onclick="showTab('notes')" id="tab-notes">üìù<br>Notes</button>
            <button class="tab-btn" onclick="showTab('read')" id="tab-read">üìö<br>Read</button>
            <button class="tab-btn" onclick="showTab('listen')" id="tab-listen">üéµ<br>Listen</button>
            <button class="tab-btn" onclick="showTab('watch')" id="tab-watch">üì∫<br>Watch</button>
            <button class="tab-btn" onclick="showTab('look')" id="tab-look">üëÅÔ∏è<br>Look</button>
            <button class="tab-btn" onclick="showTab('cook')" id="tab-cook">üç≥<br>Cook</button>
            <button class="tab-btn" onclick="showTab('make')" id="tab-make">üî®<br>Make</button>
            <button class="tab-btn" onclick="showTab('calories')" id="tab-calories">üî•<br>Calories</button>
            <button class="tab-btn" onclick="showTab('spending')" id="tab-spending">üí∞<br>Spending</button>
        </div>

        <div style="text-align: center; margin-bottom: 20px;">
            <button class="btn btn-green" onclick="downloadData()">üì• Download Data</button>
            <button class="btn" onclick="document.getElementById('upload').click()" style="background: #8b5cf6; color: white;">üì§ Upload Data</button>
            <input type="file" id="upload" accept=".json" style="display: none;" onchange="uploadData(event)">
        </div>

        <div id="content" class="content hidden"></div>
    </div>

    <script>
        let data = {
            lists: { read: [], listen: [], watch: [], cook: [], make: [], look: [] },
            notes: [],
            reading: [],
            calories: [],
            caloriesBurned: [],
            spending: [],
            calorieTable: [],
            customCalorieDays: []
        };

        function getPSTDate() {
            const now = new Date();
            // Convert to PST (UTC-8) or PDT (UTC-7)
            const pstDate = new Date(now.toLocaleString("en-US", {timeZone: "America/Los_Angeles"}));
            const year = pstDate.getFullYear();
            const month = String(pstDate.getMonth() + 1).padStart(2, '0');
            const day = String(pstDate.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getPSTTime() {
            const now = new Date();
            return new Date(now.toLocaleString("en-US", {timeZone: "America/Los_Angeles"}));
        }

        function save() {
            try {
                localStorage.setItem('notebookData', JSON.stringify(data));
            } catch (e) {
                console.error('Save error:', e);
                alert('Error saving data: ' + e.message);
            }
        }

        function load() {
            try {
                const saved = localStorage.getItem('notebookData');
                if (saved) {
                    const loadedData = JSON.parse(saved);
                    data = { ...data, ...loadedData };

                    // Clean up data structure - ensure lists contain valid items
                    if (data.lists) {
                        Object.keys(data.lists).forEach(listName => {
                            if (Array.isArray(data.lists[listName])) {
                                data.lists[listName] = data.lists[listName].filter(item =>
                                    item && typeof item === 'object' && item.title
                                );
                            } else {
                                data.lists[listName] = [];
                            }
                        });
                    }

                    // Ensure other arrays exist and are valid
                    if (!Array.isArray(data.calories)) data.calories = [];
                    if (!Array.isArray(data.caloriesBurned)) data.caloriesBurned = [];
                    if (!Array.isArray(data.spending)) data.spending = [];
                    if (!Array.isArray(data.notes)) data.notes = [];
                    if (!data.calorieTable) data.calorieTable = [];
                }
            } catch (e) {
                console.error('Load error:', e);
                alert('Error loading data: ' + e.message);
            }
        }

        function showTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));

            if (tab === 'home') {
                document.getElementById('stats').style.display = 'grid';
                document.getElementById('content').classList.add('hidden');
                document.getElementById('tab-home').classList.add('active');
                updateStats();
            } else {
                document.getElementById('stats').style.display = 'none';
                document.getElementById('content').classList.remove('hidden');
                document.getElementById('tab-' + tab).classList.add('active');
                loadTab(tab);
            }
        }

        function loadTab(tab) {
            if (['read', 'listen', 'watch', 'cook', 'make', 'look'].includes(tab)) {
                loadListTab(tab);
            } else if (tab === 'notes') {
                loadNotesTab();
            } else if (tab === 'calories') {
                loadCalorieTab();
            } else if (tab === 'spending') {
                loadSpendingTab();
            }
        }

        function loadNotesTab() {
            document.getElementById('content').innerHTML = `
                <h2>üìù Notes</h2>
                <div class="form-row">
                    <textarea id="new-note" placeholder="Write your note here... (Use ‚Ä¢ or - for bullets, Tab to indent, Shift+Tab to outdent)" onkeydown="handleNoteKeydown(event)"></textarea>
                </div>
                <div class="form-row">
                    <button class="btn btn-primary" onclick="addNote()">Add Note</button>
                </div>
                <div style="margin: 8px 0;">
                    <input type="text" id="search-notes" placeholder="üîç Search notes..." style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" oninput="filterNotes()">
                </div>
                <div id="notes-list"></div>
            `;
            renderNotes();
        }

        function loadListTab(type) {
            const emojis = {
                read: 'üìö', listen: 'üéµ', watch: 'üì∫', 
                cook: 'üç≥', make: 'üî®', look: 'üëÅÔ∏è'
            };
            
            const categoryOptions = type === 'read' ? `
                <option value="book">Book</option>
                <option value="essay">Essay</option>
                <option value="poetry">Poetry</option>
            ` : '';

            document.getElementById('content').innerHTML = `
                <h2>${emojis[type]} ${type.charAt(0).toUpperCase() + type.slice(1)}</h2>
                <div class="form-row">
                    <input type="text" id="${type}-title" placeholder="Title">
                    <input type="url" id="${type}-link" placeholder="Link (optional)">
                    ${type === 'read' ? `<select id="${type}-category">${categoryOptions}</select>` : ''}
                    <input type="date" id="${type}-date" value="${getPSTDate()}">
                    <button class="btn btn-primary" onclick="addListItem('${type}')">Add ${type.charAt(0).toUpperCase() + type.slice(1)}</button>
                </div>
                <div style="margin: 8px 0;">
                    <input type="text" id="search-${type}" placeholder="üîç Search..." style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" oninput="filterItems('${type}')">
                </div>
                <div id="${type}-list"></div>
            `;
            renderList(type);
        }

        // Global variable to store current calorie view week
        let currentCalorieWeek = getPSTTime();

        function loadCalorieTab() {
            const content = document.getElementById('content');
            let html = '<h2>CALORIE TRACKING</h2>';
            
            // Simple calorie entry form
            html += '<div class="form-row">' +
                    '<input type="text" id="food-input" placeholder="Food item" style="flex: 2;">' +
                    '<input type="number" id="calories-input" placeholder="Calories" min="0">' +
                    '<input type="number" id="protein-input" placeholder="Protein (g)" min="0" step="0.1">' +
                    '<input type="date" id="cal-date-input" value="' + getPSTDate() + '">' +
                    '<button class="btn btn-primary" onclick="addCalorie()">Add</button>' +
                    '</div>';
                    
            // Calories burned form
            html += '<div class="form-row">' +
                    '<input type="text" id="exercise-input" placeholder="Exercise/Activity" style="flex: 2;">' +
                    '<input type="number" id="burned-input" placeholder="Calories burned" min="0">' +
                    '<input type="date" id="burned-date-input" value="' + getPSTDate() + '">' +
                    '<button class="btn btn-green" onclick="addCalorieBurned()">Add Burned</button>' +
                    '</div>';

            // Week navigation
            html += '<div style="display: flex; align-items: center; justify-content: space-between; margin: 15px 0; background: #f8fafc; padding: 10px; border-radius: 8px;">';
            html += '<button class="btn" onclick="changeCalorieWeek(-1)" style="background: #6b7280; color: white;">‚Üê Previous Week</button>';
            html += '<div style="text-align: center; font-weight: 600; color: #374151;">' + formatWeekHeader(currentCalorieWeek) + '</div>';
            html += '<button class="btn" onclick="changeCalorieWeek(1)" style="background: #6b7280; color: white;">Next Week ‚Üí</button>';
            html += '</div>';
            
            // Add day and fill missing day buttons
            html += '<div style="text-align: center; margin: 15px 0; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">';
            html += '<button class="btn" onclick="addDay()" style="background: #8b5cf6; color: white;">üìÖ Add Day</button>';
            html += '<button class="btn" onclick="fillMissingDays()" style="background: #f59e0b; color: white;">üîÑ Fill Missing Days</button>';
            html += '<button class="btn" onclick="goToToday()" style="background: #10b981; color: white;">üè† Today</button>';
            html += '</div>';

            // Enhanced calorie table
            html += '<h3>Weekly Calorie Overview</h3>';
            html += generateCalorieTable();
            
            content.innerHTML = html;
        }

        function loadSpendingTab() {
            const content = document.getElementById('content');
            let html = '<h2>SPENDING TRACKER</h2>';
            
            html += '<div class="form-row">' +
                    '<input type="text" id="spend-desc" placeholder="Description" style="flex: 2;">' +
                    '<input type="number" id="spend-amount" placeholder="Amount" min="0" step="0.01">' +
                    '<select id="spend-category">' +
                    '<option value="food">Food</option>' +
                    '<option value="grocery">Grocery</option>' +
                    '<option value="doordash">DoorDash</option>' +
                    '<option value="instacart">Instacart</option>' +
                    '<option value="transport">Transport</option>' +
                    '<option value="entertainment">Entertainment</option>' +
                    '<option value="shopping">Shopping</option>' +
                    '<option value="streaming">Streaming</option>' +
                    '<option value="news/magazine">News/Magazine</option>' +
                    '<option value="bills">Bills</option>' +
                    '<option value="subscription">Subscription</option>' +
                    '<option value="health">Health</option>' +
                    '<option value="wedding/vacation">Wedding/Vacation</option>' +
                    '<option value="reimbursable">Reimbursable</option>' +
                    '<option value="other">Other</option>' +
                    '</select>' +
                    '<input type="date" id="spend-date" value="' + getPSTDate() + '">' +
                    '<button class="btn btn-primary" onclick="addSpending()">Add</button>' +
                    '</div>';

            // Spending analytics
            html += generateSpendingAnalytics();
            
            // Add filter controls
            html += '<div class="filter-controls">' +
                    '<div class="filter-row">' +
                    '<span class="filter-label">Date Range:</span>' +
                    '<input type="date" id="filter-date-from" class="filter-input" placeholder="From date">' +
                    '<span style="margin: 0 8px;">to</span>' +
                    '<input type="date" id="filter-date-to" class="filter-input" placeholder="To date">' +
                    '</div>' +
                    '<div class="filter-row">' +
                    '<span class="filter-label">Category:</span>' +
                    '<select id="filter-category" class="filter-input">' +
                    '<option value="">All Categories</option>' +
                    '</select>' +
                    '<button class="btn btn-primary" onclick="applySpendingFilters()">Apply Filters</button>' +
                    '<button class="btn" onclick="clearSpendingFilters()">Clear Filters</button>' +
                    '</div>' +
                    '</div>';
                    
            // Recent spending
            html += '<h3>Recent Spending</h3>';
            html += '<div id="spending-list">';
            html += '</div>';
            
            content.innerHTML = html;
            populateCategoryFilter();
            renderSpending();
        }

        function addNote() {
            const content = document.getElementById('new-note').value.trim();
            if (!content) return;
            
            const note = {
                id: Date.now(),
                content: content,
                date: getPSTDate()
            };
            
            data.notes.unshift(note);
            document.getElementById('new-note').value = '';
            save();
            renderNotes();
        }

        function renderNotes() {
            const notesList = document.getElementById('notes-list');
            if (!notesList) return;
            
            if (data.notes.length === 0) {
                notesList.innerHTML = '<p>No notes yet.</p>';
                return;
            }
            
            notesList.innerHTML = data.notes.map((note, i) => `
                <div class="item item-note-${i}" data-search="${(note.content || '').toLowerCase()}">
                    <div class="item-content" onclick="editNote(${note.id}, event)" style="cursor: pointer;" title="Click to edit">
                        <div class="note-date">${note.date}</div>
                        <div class="note-content">${formatNoteContent(note.content)}</div>
                    </div>
                    <div class="item-actions">
                        <button class="btn" onclick="deleteNote(${note.id})" style="padding: 4px 8px; font-size: 12px;">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
            forceDeleteButtonStyling();
        }

        function deleteNote(id) {
            data.notes = data.notes.filter(note => note.id !== id);
            save();
            renderNotes();
        }

        function handleNoteKeydown(event) {
            const textarea = event.target;
            const cursorPos = textarea.selectionStart;
            const textBeforeCursor = textarea.value.substring(0, cursorPos);
            const currentLine = textBeforeCursor.split('\n').pop();
            
            if (event.key === 'Enter') {
                // Check if current line starts with bullet point
                if (currentLine.match(/^[\s]*[‚Ä¢\-]\s/)) {
                    event.preventDefault();
                    const bulletMatch = currentLine.match(/^(\s*)[‚Ä¢\-](\s+)/);
                    if (bulletMatch) {
                        const indent = bulletMatch[1];
                        const spacing = bulletMatch[2];
                        const newBullet = `\n${indent}‚Ä¢ ${spacing}`;
                        
                        const textAfterCursor = textarea.value.substring(cursorPos);
                        textarea.value = textBeforeCursor + newBullet + textAfterCursor;
                        textarea.selectionStart = textarea.selectionEnd = cursorPos + newBullet.length;
                    }
                }
            }
            
            // Handle Tab for indenting bullet points
            if (event.key === 'Tab') {
                if (currentLine.match(/^[\s]*[‚Ä¢\-]\s/)) {
                    event.preventDefault();
                    const lineStart = textBeforeCursor.lastIndexOf('\n') + 1;
                    const beforeLine = textBeforeCursor.substring(0, lineStart);
                    const textAfterCursor = textarea.value.substring(cursorPos);
                    
                    if (event.shiftKey) {
                        // Shift+Tab: Remove indentation (outdent)
                        const updatedLine = currentLine.replace(/^  /, ''); // Remove 2 spaces
                        if (updatedLine !== currentLine) {
                            textarea.value = beforeLine + updatedLine + textAfterCursor;
                            textarea.selectionStart = textarea.selectionEnd = cursorPos - 2;
                        }
                    } else {
                        // Tab: Add indentation (indent)
                        const updatedLine = '  ' + currentLine; // Add 2 spaces
                        textarea.value = beforeLine + updatedLine + textAfterCursor;
                        textarea.selectionStart = textarea.selectionEnd = cursorPos + 2;
                    }
                }
            }
            
            // Auto-convert - to ‚Ä¢ at start of line
            if (event.key === ' ') {
                if (currentLine === '-' || currentLine.match(/^\s*-$/)) {
                    event.preventDefault();
                    const spaces = currentLine.match(/^(\s*)-$/)?.[1] || '';
                    const newText = textBeforeCursor.slice(0, -1) + '‚Ä¢ ';
                    const textAfterCursor = textarea.value.substring(cursorPos);
                    textarea.value = newText + textAfterCursor;
                    textarea.selectionStart = textarea.selectionEnd = newText.length;
                }
            }
        }

        function formatNoteContent(content) {
            if (!content) return '';
            
            // Convert bullet points to HTML with proper indentation
            return content
                .split('\n')
                .map(line => {
                    // Handle bullet points with indentation
                    const bulletMatch = line.match(/^(\s*)[‚Ä¢\-]\s(.*)$/);
                    if (bulletMatch) {
                        const indent = bulletMatch[1];
                        const text = bulletMatch[2];
                        const indentLevel = Math.floor(indent.length / 2);
                        const indentClass = indentLevel > 0 ? ` class="indent-${Math.min(indentLevel, 3)}"` : '';
                        return `<li${indentClass}>${text}</li>`;
                    }
                    return line;
                })
                .join('\n')
                .replace(/(<li.*<\/li>\n?)+/g, match => `<ul>${match}</ul>`)
                .replace(/\n/g, '<br>');
        }

        function addListItem(type) {
            const title = document.getElementById(`${type}-title`).value.trim();
            const link = document.getElementById(`${type}-link`).value.trim();
            const date = document.getElementById(`${type}-date`).value;
            const category = document.getElementById(`${type}-category`)?.value || '';
            
            if (!title) return;
            
            const item = {
                id: Date.now(),
                title: title,
                link: link,
                date: date,
                completed: false,
                ...(category && { category: category })
            };
            
            data.lists[type].unshift(item);
            
            // Clear inputs
            document.getElementById(`${type}-title`).value = '';
            document.getElementById(`${type}-link`).value = '';
            if (document.getElementById(`${type}-category`)) {
                document.getElementById(`${type}-category`).value = 'book';
            }
            
            save();
            renderList(type);
        }

        function renderList(type) {
            const listDiv = document.getElementById(`${type}-list`);
            if (!listDiv) return;
            
            const items = data.lists[type] || [];
            
            if (items.length === 0) {
                listDiv.innerHTML = `<p>No ${type} items yet.</p>`;
                return;
            }
            
            listDiv.innerHTML = items.map((item, i) => `
                <div class="item item-${type}-${i}" data-search="${(item.title || '').toLowerCase()}" style="background: ${getBackgroundColorForType(type, item.category)};">
                    <div class="item-content">
                        <div style="text-decoration: ${item.completed ? 'line-through' : 'none'};">
                            <span class="editable-text" onclick="editListItem('${type}', ${item.id}, 'title')" title="Click to edit title" style="cursor: pointer;">${item.title}</span>
                            ${item.category && type === 'read' ? ` <span class="editable-text" onclick="editListItem('${type}', ${item.id}, 'category')" title="Click to edit category" style="color: #666; font-size: 11px; cursor: pointer;">(${item.category})</span>` : (item.category ? ` <span class="editable-text" onclick="editListItem('${type}', ${item.id}, 'category')" title="Click to edit category" style="background: ${getCategoryColorForType(type, item.category)}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; cursor: pointer;">${item.category}</span>` : '')}
                        </div>
                        <div style="font-size: 12px; color: #666;" class="editable-text" onclick="editListItem('${type}', ${item.id}, 'date')" title="Click to edit date">${item.date}</div>
                    </div>
                    <div class="item-actions">
                        ${item.link ? `<button class="btn" onclick="openLink('${item.link}')" style="padding: 4px 8px; font-size: 12px;">üîó</button>` : ''}
                        <button class="btn" onclick="deleteListItem('${type}', ${item.id})" style="padding: 4px 8px; font-size: 12px;">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function toggleItem(type, id) {
            const item = data.lists[type].find(item => item.id === id);
            if (item) {
                item.completed = !item.completed;
                save();
                renderList(type);
                updateStats();
            }
        }

        function editListItem(type, id, field) {
            const item = data.lists[type].find(item => item.id === id);
            if (!item) return;
            
            let currentValue = item[field];
            let newValue;

            if (field === 'category') {
                let categories;
                if (type === 'read') {
                    categories = ['book', 'essay', 'poetry'];
                } else {
                    categories = ['podcast', 'video', 'course', 'other'];
                }
                const currentIndex = categories.indexOf(currentValue || categories[0]);
                const nextIndex = (currentIndex + 1) % categories.length;
                newValue = categories[nextIndex];
            } else if (field === 'date') {
                newValue = prompt('Edit date (YYYY-MM-DD):', currentValue);
                if (!newValue || !/^\d{4}-\d{2}-\d{2}$/.test(newValue)) {
                    return;
                }
            } else {
                newValue = prompt(`Edit ${field}:`, currentValue);
                if (!newValue) return;
            }

            item[field] = newValue;
            save();
            renderList(type);
            updateStats();
        }

        function deleteListItem(type, id) {
            data.lists[type] = data.lists[type].filter(item => item.id !== id);
            save();
            renderList(type);
        }

        function openLink(link) {
            if (link) {
                window.open(link, '_blank');
            }
        }

        function filterItems(listName) {
            const searchTerm = document.getElementById('search-' + listName).value.toLowerCase();
            const items = data.lists[listName] || [];
            
            // If search is empty, show all items
            if (!searchTerm) {
                items.forEach((item, i) => {
                    const element = document.querySelector(`.item-${listName}-${i}`);
                    if (element) element.style.display = 'flex';
                });
                return;
            }
            
            // Hide all items first
            items.forEach((item, i) => {
                const element = document.querySelector(`.item-${listName}-${i}`);
                if (element) element.style.display = 'none';
            });
            
            // Show matching items
            items.forEach((item, i) => {
                if (item.title.toLowerCase().includes(searchTerm) || 
                    (item.category && item.category.toLowerCase().includes(searchTerm))) {
                    const element = document.querySelector(`.item-${listName}-${i}`);
                    if (element) element.style.display = 'flex';
                }
            });
        }

        function filterNotes() {
            const searchTerm = document.getElementById('search-notes').value.toLowerCase();
            
            // If search is empty, show all notes
            if (!searchTerm) {
                data.notes.forEach((note, i) => {
                    const element = document.querySelector(`.note-item-${i}`);
                    if (element) element.style.display = 'block';
                });
                return;
            }
            
            // Hide all notes first
            data.notes.forEach((note, i) => {
                const element = document.querySelector(`.note-item-${i}`);
                if (element) element.style.display = 'none';
            });
            
            // Show matching notes
            data.notes.forEach((note, i) => {
                if (note.content.toLowerCase().includes(searchTerm)) {
                    const element = document.querySelector(`.note-item-${i}`);
                    if (element) element.style.display = 'block';
                }
            });
        }

        function formatWeekHeader(date) {
            const startOfWeek = getPSTTime();
            startOfWeek.setTime(date.getTime());
            startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            
            const options = { month: 'short', day: 'numeric', timeZone: 'America/Los_Angeles' };
            return `${startOfWeek.toLocaleDateString('en-US', options)} - ${endOfWeek.toLocaleDateString('en-US', options)}`;
        }

        function changeCalorieWeek(direction) {
            const newDate = new Date(currentCalorieWeek);
            newDate.setDate(currentCalorieWeek.getDate() + (direction * 7));
            currentCalorieWeek = newDate;
            loadCalorieTab();
        }

        function addDay() {
            // Simply add tomorrow's date (PST)
            const tomorrow = getPSTTime();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const dateToAdd = tomorrow.toISOString().split('T')[0];
            
            // Initialize customCalorieDays if it doesn't exist
            if (!data.customCalorieDays) {
                data.customCalorieDays = [];
            }
            
            // Add the date if not already present
            if (!data.customCalorieDays.includes(dateToAdd)) {
                data.customCalorieDays.push(dateToAdd);
                save();
            }
            
            // Navigate to show this week
            currentCalorieWeek = tomorrow;
            loadCalorieTab();
        }

        function fillMissingDays() {
            if (!data.calories.length && !data.caloriesBurned.length) {
                alert('No calorie data found. Add some entries first.');
                return;
            }
            
            // Find the earliest and latest dates in the data
            const allDates = [
                ...data.calories.map(c => c.date),
                ...data.caloriesBurned.map(c => c.date)
            ].filter(date => date).sort();
            
            if (allDates.length === 0) {
                alert('No dates found in calorie data.');
                return;
            }
            
            const startDate = new Date(allDates[0]);
            const endDate = new Date(allDates[allDates.length - 1]);
            
            const missingDates = [];
            for (let date = new Date(startDate); date <= endDate; date.setDate(date.getDate() + 1)) {
                const dateStr = date.toISOString().split('T')[0];
                if (!allDates.includes(dateStr)) {
                    missingDates.push(dateStr);
                }
            }
            
            if (missingDates.length === 0) {
                alert('No missing days found.');
                return;
            }
            
            // Initialize customCalorieDays if it doesn't exist
            if (!data.customCalorieDays) {
                data.customCalorieDays = [];
            }
            
            // Add missing dates
            missingDates.forEach(dateStr => {
                if (!data.customCalorieDays.includes(dateStr)) {
                    data.customCalorieDays.push(dateStr);
                }
            });
            
            save();
            loadCalorieTab();
            
            if (missingDates.length > 0) {
                alert(`Added ${missingDates.length} missing days to your calendar.`);
            }
        }

        function goToToday() {
            currentCalorieWeek = new Date();
            loadCalorieTab();
        }

        function addCalorie() {
            const food = document.getElementById('food-input').value.trim();
            const calories = document.getElementById('calories-input').value;
            const protein = document.getElementById('protein-input').value || '0';
            const date = document.getElementById('cal-date-input').value;
            
            if (!food || !calories) {
                alert('Please enter food and calories');
                return;
            }
            
            data.calories.push({ food, calories, protein, date });
            save();
            loadCalorieTab();
            updateStats();
            
            // Clear inputs
            document.getElementById('food-input').value = '';
            document.getElementById('calories-input').value = '';
            document.getElementById('protein-input').value = '';
            document.getElementById('cal-date-input').value = getPSTDate();
        }

        function addCalorieBurned() {
            const exercise = document.getElementById('exercise-input').value.trim();
            const calories = document.getElementById('burned-input').value;
            const date = document.getElementById('burned-date-input').value;
            
            if (!exercise || !calories) {
                alert('Please enter exercise and calories burned');
                return;
            }
            
            data.caloriesBurned.push({ exercise, calories, date });
            save();
            loadCalorieTab();
            updateStats();
            
            // Clear inputs
            document.getElementById('exercise-input').value = '';
            document.getElementById('burned-input').value = '';
            document.getElementById('burned-date-input').value = getPSTDate();
        }

        function generateCalorieTable() {
            const viewWeek = [];
            
            // Use the currentCalorieWeek variable (which can be changed by navigation)
            const currentPST = new Date(currentCalorieWeek.toLocaleString("en-US", {timeZone: "America/Los_Angeles"}));
            const dayOfWeek = currentPST.getDay(); // 0 = Sunday, 6 = Saturday
            
            // Calculate start of week (Sunday)
            const startOfWeek = new Date(currentPST);
            startOfWeek.setDate(currentPST.getDate() - dayOfWeek); // Go back to Sunday
            
            // Generate Sunday through Saturday (7 days)
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(startOfWeek);
                dayDate.setDate(startOfWeek.getDate() + i);
                
                // Format as YYYY-MM-DD in PST
                const pstString = dayDate.toLocaleDateString('en-CA', {timeZone: 'America/Los_Angeles'});
                viewWeek.push(pstString);
            }
            
            // Add any custom tracked days for this week
            if (data.customCalorieDays) {
                data.customCalorieDays.forEach(customDate => {
                    const customDateObj = new Date(customDate);
                    if (customDateObj >= startOfWeek && customDateObj < new Date(startOfWeek.getTime() + 7 * 24 * 60 * 60 * 1000)) {
                        if (!viewWeek.includes(customDate)) {
                            viewWeek.push(customDate);
                        }
                    }
                });
            }
            
            // Sort dates to display in order
            viewWeek.sort();
            
            let html = '<table class="calorie-table">';
            html += '<thead><tr><th>Day</th><th>Consumed</th><th>Burned</th><th>Net</th><th>Protein</th></tr></thead><tbody>';
            
            viewWeek.forEach(dateStr => {
                const dayName = new Date(dateStr + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'short', timeZone: 'America/Los_Angeles' });
                const consumed = data.calories.filter(c => c.date === dateStr).reduce((sum, c) => sum + parseInt(c.calories || c.amount || 0), 0);
                const burned = data.caloriesBurned.filter(c => c.date === dateStr).reduce((sum, c) => sum + parseInt(c.calories || 0), 0);
                const protein = data.calories.filter(c => c.date === dateStr).reduce((sum, c) => sum + parseFloat(c.protein || 0), 0);
                const net = consumed - burned;
                
                const netClass = net > 0 ? 'net-positive' : net < 0 ? 'net-negative' : 'net-neutral';
                const isToday = dateStr === getPSTDate() ? ' style="background: #fef3c7;"' : '';
                
                html += `<tr${isToday}>
                    <td><strong>${dayName}</strong><br><small>${dateStr}</small></td>
                    <td class="editable-cell consumed-cell" onclick="editCell(this, 'consumed', '${dateStr}')">${consumed}</td>
                    <td class="editable-cell burned-cell" onclick="editCell(this, 'burned', '${dateStr}')">${burned}</td>
                    <td class="${netClass}">${net > 0 ? '+' : ''}${net}</td>
                    <td class="protein-cell">${protein.toFixed(1)}g</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            
            // Week summary
            const weekConsumed = viewWeek.reduce((sum, date) => {
                return sum + data.calories.filter(c => c.date === date).reduce((daySum, c) => daySum + parseInt(c.calories || c.amount || 0), 0);
            }, 0);
            const weekBurned = viewWeek.reduce((sum, date) => {
                return sum + data.caloriesBurned.filter(c => c.date === date).reduce((daySum, c) => daySum + parseInt(c.calories || 0), 0);
            }, 0);
            const weekProtein = viewWeek.reduce((sum, date) => {
                return sum + data.calories.filter(c => c.date === date).reduce((daySum, c) => daySum + parseFloat(c.protein || 0), 0);
            }, 0);
            const weekNet = weekConsumed - weekBurned;
            
            html += `<div class="week-summary">
                <h4>Week Summary</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 10px;">
                    <div class="summary-card">
                        <div class="summary-value" style="color: #059669; font-weight: 600;">${weekConsumed}</div>
                        <div class="summary-label">Consumed</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value" style="color: #dc2626; font-weight: 600;">${weekBurned}</div>
                        <div class="summary-label">Burned</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value" style="color: ${weekNet < 0 ? '#059669' : '#dc2626'}; font-weight: 600;">${weekNet > 0 ? '+' : ''}${weekNet}</div>
                        <div class="summary-label">Net</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value" style="color: #8b5cf6; font-weight: 600;">${weekProtein.toFixed(1)}g</div>
                        <div class="summary-label">Protein</div>
                    </div>
                </div>
            </div>`;
            
            return html;
        }

        function editCell(cell, type, date) {
            if (cell.classList.contains('editing')) return;
            
            const currentValue = cell.textContent;
            const input = document.createElement('input');
            input.type = 'number';
            input.value = currentValue;
            input.style.width = '80px';
            input.style.border = 'none';
            input.style.background = 'transparent';
            input.style.textAlign = 'center';
            
            cell.classList.add('editing');
            cell.textContent = '';
            cell.appendChild(input);
            input.focus();
            input.select();
            
            function saveEdit() {
                const newValue = parseInt(input.value) || 0;
                cell.classList.remove('editing');
                cell.textContent = newValue;
                
                // Update the data
                if (type === 'consumed') {
                    // Clear all existing entries for this date and create a single new one
                    data.calories = data.calories.filter(c => c.date !== date);
                    const entry = { 
                        id: Date.now(),
                        date: date, 
                        food: 'Manual edit', 
                        calories: newValue.toString(), 
                        amount: newValue,
                        protein: '0'
                    };
                    data.calories.push(entry);
                } else if (type === 'burned') {
                    // Clear all existing burned entries for this date and create a single new one
                    data.caloriesBurned = data.caloriesBurned.filter(c => c.date !== date);
                    const entry = { 
                        id: Date.now(),
                        date: date, 
                        exercise: 'Manual edit', 
                        calories: newValue.toString()
                    };
                    data.caloriesBurned.push(entry);
                }
                
                save();
                loadCalorieTab(); // Refresh to recalculate totals
                updateStats();
            }
            
            input.onblur = saveEdit;
            input.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    saveEdit();
                }
            };
        }





        function addSpending() {
            const description = document.getElementById('spend-desc').value.trim();
            const amount = document.getElementById('spend-amount').value;
            const category = document.getElementById('spend-category').value;
            const date = document.getElementById('spend-date').value;
            
            if (!description || !amount) {
                alert('Please enter description and amount');
                return;
            }
            
            data.spending.push({ description, amount, category, date });
            save();
            loadSpendingTab();
            updateStats();
            
            // Clear inputs
            document.getElementById('spend-desc').value = '';
            document.getElementById('spend-amount').value = '';
            document.getElementById('spend-category').value = 'food';
            document.getElementById('spend-date').value = getPSTDate();
        }

        function getCategoryColor(category) {
            const colors = {
                food: '#f59e0b',
                grocery: '#16a34a',
                doordash: '#ff6b6b',
                instacart: '#4ecdc4',
                transport: '#3b82f6',
                entertainment: '#8b5cf6',
                shopping: '#ec4899',
                streaming: '#db2777',
                'news/magazine': '#059669',
                bills: '#ef4444',
                subscription: '#06b6d4',
                health: '#10b981',
                'wedding/vacation': '#d97706',
                reimbursable: '#7c3aed',
                other: '#6b7280'
            };
            return colors[category] || '#6b7280';
        }

        function getCategoryColorForType(type, category) {
            if (type === 'read') {
                const readColors = {
                    book: '#8b5cf6',      // Purple for books
                    essay: '#f59e0b',     // Orange for essays  
                    poetry: '#ec4899'     // Pink for poetry
                };
                return readColors[category] || '#3b82f6';
            }
            return '#3b82f6'; // Default blue for other types
        }

        function getBackgroundColorForType(type, category) {
            if (type === 'read') {
                const backgroundColors = {
                    book: '#e0f2fe',      // Light blue for books
                    essay: '#f0fdf4',     // Light green for essays
                    poetry: '#fdf2f8'     // Light pink for poetry
                };
                return backgroundColors[category] || '#ffffff';
            }
            return '#ffffff'; // Default white for other types
        }

        function generateSpendingAnalytics() {
            const today = getPSTTime();
            const todayStr = getPSTDate();
            
            // This week
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay());
            startOfWeek.setHours(0, 0, 0, 0);
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            endOfWeek.setHours(23, 59, 59, 999);
            
            // This month
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            const todaySpending = data.spending.filter(s => s.date === todayStr).reduce((sum, s) => sum + parseFloat(s.amount), 0);
            const weekSpending = data.spending.filter(s => {
                const spendDate = new Date(s.date + 'T00:00:00');
                return spendDate >= startOfWeek && spendDate <= endOfWeek;
            }).reduce((sum, s) => sum + parseFloat(s.amount), 0);
            const monthSpending = data.spending.filter(s => {
                const spendDate = new Date(s.date + 'T00:00:00');
                return spendDate >= startOfMonth && spendDate <= endOfMonth;
            }).reduce((sum, s) => sum + parseFloat(s.amount), 0);
            
            // Category breakdown for this month
            const categoryTotals = {};
            data.spending.filter(s => {
                const spendDate = new Date(s.date);
                return spendDate >= startOfMonth && spendDate <= endOfMonth;
            }).forEach(spend => {
                categoryTotals[spend.category] = (categoryTotals[spend.category] || 0) + parseFloat(spend.amount);
            });
            
            let html = '<div class="week-summary">';
            html += '<div class="week-header">üìä Spending Analytics</div>';
            html += '<div class="week-stats">';
            html += `<div class="week-stat"><div class="week-stat-label">Today</div><div class="week-stat-value" style="color: #dc2626;">$${todaySpending.toFixed(2)}</div></div>`;
            html += `<div class="week-stat"><div class="week-stat-label">This Week</div><div class="week-stat-value" style="color: #dc2626;">$${weekSpending.toFixed(2)}</div></div>`;
            html += `<div class="week-stat"><div class="week-stat-label">This Month</div><div class="week-stat-value" style="color: #dc2626;">$${monthSpending.toFixed(2)}</div></div>`;
            html += '</div>';
            
            // Category breakdown
            if (Object.keys(categoryTotals).length > 0) {
                html += '<div style="margin-top: 12px;"><strong>This Month by Category:</strong></div>';
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 8px; margin-top: 8px;">';
                Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]).forEach(([category, amount]) => {
                    const color = getCategoryColor(category);
                    html += `<div class="spending-category">
                        <div class="spending-category-header" style="color: ${color};">${category.charAt(0).toUpperCase() + category.slice(1)}</div>
                        <div style="font-weight: 600;">$${amount.toFixed(2)}</div>
                    </div>`;
                });
                html += '</div>';
            }
            
            html += '</div>';
            return html;
        }

        function deleteSpending(index) {
            if (confirm('Delete this spending entry?')) {
                data.spending.splice(index, 1);
                save();
                loadSpendingTab();
                updateStats();
            }
        }

        function editSpending(index, field) {
            const spend = data.spending[index];
            let currentValue = spend[field];
            let newValue;

            if (field === 'category') {
                const categories = ['food', 'grocery', 'doordash', 'instacart', 'transport', 'entertainment', 'shopping', 'streaming', 'news/magazine', 'bills', 'subscription', 'health', 'wedding/vacation', 'reimbursable', 'other'];
                const currentIndex = categories.indexOf(currentValue);
                const nextIndex = (currentIndex + 1) % categories.length;
                newValue = categories[nextIndex];
            } else if (field === 'amount') {
                newValue = prompt('Edit amount (without $):', currentValue);
                if (newValue && !isNaN(parseFloat(newValue))) {
                    newValue = parseFloat(newValue).toString();
                } else {
                    return;
                }
            } else if (field === 'date') {
                newValue = prompt('Edit date (YYYY-MM-DD):', currentValue);
                if (!newValue || !/^\d{4}-\d{2}-\d{2}$/.test(newValue)) {
                    return;
                }
            } else {
                newValue = prompt(`Edit ${field}:`, currentValue);
                if (!newValue) return;
            }

            data.spending[index][field] = newValue;
            save();
            loadSpendingTab();
            updateStats();
        }

        function populateCategoryFilter() {
            const categorySelect = document.getElementById('filter-category');
            if (!categorySelect) return;
            
            const categories = [...new Set(data.spending.map(entry => entry.category))].sort();
            
            // Keep the "All Categories" option and add unique categories
            categorySelect.innerHTML = '<option value="">All Categories</option>' + 
                categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }

        function applySpendingFilters() {
            renderSpending();
        }

        function clearSpendingFilters() {
            document.getElementById('filter-date-from').value = '';
            document.getElementById('filter-date-to').value = '';
            document.getElementById('filter-category').value = '';
            renderSpending();
        }

        function getFilteredSpendingEntries() {
            const dateFrom = document.getElementById('filter-date-from')?.value;
            const dateTo = document.getElementById('filter-date-to')?.value;
            const category = document.getElementById('filter-category')?.value;
            
            let filtered = [...data.spending];
            
            // Apply date filters
            if (dateFrom) {
                filtered = filtered.filter(entry => entry.date >= dateFrom);
            }
            if (dateTo) {
                filtered = filtered.filter(entry => entry.date <= dateTo);
            }
            
            // Apply category filter
            if (category) {
                filtered = filtered.filter(entry => entry.category === category);
            }
            
            return filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        function renderSpending() {
            const listDiv = document.getElementById('spending-list');
            if (!listDiv) return;
            
            const filteredEntries = getFilteredSpendingEntries();
            
            // Calculate filtered total
            const filteredTotal = filteredEntries.reduce((sum, spend) => sum + parseFloat(spend.amount), 0);
            
            let html = '';
            
            // Add filtered total display if filters are active
            const dateFrom = document.getElementById('filter-date-from')?.value;
            const dateTo = document.getElementById('filter-date-to')?.value;
            const category = document.getElementById('filter-category')?.value;
            
            if (dateFrom || dateTo || category) {
                html += `<div style="background: #f0f9ff; border: 2px solid #3b82f6; border-radius: 8px; padding: 12px; margin-bottom: 16px; text-align: center;">
                    <div style="font-weight: 600; color: #1e40af; font-size: 16px;">Filtered Total</div>
                    <div style="font-size: 24px; font-weight: 700; color: #dc2626; margin-top: 4px;">$${filteredTotal.toFixed(2)}</div>
                    <div style="font-size: 12px; color: #64748b; margin-top: 2px;">${filteredEntries.length} entries</div>
                </div>`;
            }
            
            filteredEntries.forEach((spend, i) => {
                const categoryColor = getCategoryColor(spend.category);
                const originalIndex = data.spending.findIndex(s => s === spend);
                html += `<div class="item">
                    <div class="item-content">üí∞ 
                        <span class="editable-text" onclick="editSpending(${originalIndex}, 'description')" title="Click to edit description">${spend.description}</span> - 
                        <span class="editable-text" onclick="editSpending(${originalIndex}, 'amount')" title="Click to edit amount" style="color: #dc2626; font-weight: 600;">$${parseFloat(spend.amount).toFixed(2)}</span> 
                        <span class="editable-text" onclick="editSpending(${originalIndex}, 'category')" title="Click to edit category" style="background: ${categoryColor}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; cursor: pointer;">${spend.category}</span>
                        <small class="editable-text" onclick="editSpending(${originalIndex}, 'date')" title="Click to edit date" style="color: #666; cursor: pointer;"> (${spend.date})</small>
                    </div>
                    <div class="item-actions">
                        <button class="btn" onclick="deleteSpending(${originalIndex})" style="padding: 4px 8px; font-size: 12px;">üóëÔ∏è</button>
                    </div>
                </div>`;
            });
            listDiv.innerHTML = html;
            forceDeleteButtonStyling();
        }

        function updateStats() {
            const today = getPSTDate();
            
            // Normalize calorie data
            const normalizedCalories = data.calories.map(entry => ({
                date: entry.date,
                calories: parseInt(entry.amount) || parseInt(entry.calories) || 0,
                protein: parseInt(entry.protein) || 0
            }));
            
            // Calculate calorie stats
            const todayCalories = normalizedCalories
                .filter(entry => entry.date === today)
                .reduce((sum, entry) => sum + entry.calories, 0);
            
            const todayProtein = normalizedCalories
                .filter(entry => entry.date === today)
                .reduce((sum, entry) => sum + entry.protein, 0);
            
            const todayBurned = data.caloriesBurned
                .filter(entry => entry.date === today)
                .reduce((sum, entry) => sum + (parseInt(entry.calories) || 0), 0);
            
            const netCalories = todayCalories - todayBurned;
            
            document.getElementById('cal-today').textContent = `${todayCalories} cal today`;
            document.getElementById('protein-today').textContent = `${todayProtein}g protein`;
            
            if (todayBurned > 0) {
                const balanceElement = document.getElementById('balance-today');
                balanceElement.textContent = `${netCalories > 0 ? '+' : ''}${netCalories} cal`;
                // Make negative values green
                balanceElement.style.color = netCalories < 0 ? '#059669' : '#f59e0b';
            } else {
                const balanceElement = document.getElementById('balance-today');
                balanceElement.textContent = 'Enter burned calories';
                balanceElement.style.color = '#f59e0b';
            }
            
            // Calculate spending stats
            const todaySpending = data.spending
                .filter(entry => entry.date === today)
                .reduce((sum, entry) => sum + (parseFloat(entry.amount) || 0), 0);
            
            const thisWeekStart = new Date();
            thisWeekStart.setDate(thisWeekStart.getDate() - thisWeekStart.getDay());
            const weekStartStr = thisWeekStart.toISOString().split('T')[0];
            
            const weekSpending = data.spending
                .filter(entry => entry.date >= weekStartStr)
                .reduce((sum, entry) => sum + (parseFloat(entry.amount) || 0), 0);
            
            const thisMonthStart = new Date();
            thisMonthStart.setDate(1);
            const monthStartStr = thisMonthStart.toISOString().split('T')[0];
            
            const monthSpending = data.spending
                .filter(entry => entry.date >= monthStartStr)
                .reduce((sum, entry) => sum + (parseFloat(entry.amount) || 0), 0);
            
            document.getElementById('spend-today').textContent = `$${todaySpending.toFixed(2)} today`;
            document.getElementById('spend-week').textContent = `$${weekSpending.toFixed(2)} this week`;
            document.getElementById('spend-month').textContent = `$${monthSpending.toFixed(2)} this month`;
        }

        function downloadData() {
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `notebook-data-${getPSTDate()}_${Date.now()}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function uploadData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const uploadedData = JSON.parse(e.target.result);
                    
                    // Convert spending amounts from strings to numbers if needed
                    if (uploadedData.spending) {
                        uploadedData.spending = uploadedData.spending.map(entry => ({
                            ...entry,
                            amount: parseFloat(entry.amount) || 0
                        }));
                    }
                    
                    // Convert calorie data from various formats
                    if (uploadedData.calories) {
                        uploadedData.calories = uploadedData.calories.map(entry => {
                            // Handle different possible field names
                            const calories = entry.calories || entry.amount || 0;
                            const protein = entry.protein || 0;
                            const description = entry.description || entry.food || '';
                            
                            return {
                                id: entry.id || Date.now() + Math.random(),
                                description: description,
                                amount: parseFloat(calories) || 0,
                                protein: parseFloat(protein) || 0,
                                date: entry.date
                            };
                        });
                    }
                    
                    data = uploadedData;
                    save();
                    alert('Data uploaded successfully!');
                    
                    // Refresh current view if needed
                    const activeTab = document.querySelector('.tab-btn.active');
                    if (activeTab && activeTab.id !== 'tab-home') {
                        const tabName = activeTab.id.replace('tab-', '');
                        showTab(tabName);
                    }
                    updateStats();
                } catch (error) {
                    alert('Error uploading data: Invalid JSON file');
                    console.error('Upload error:', error);
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        // Force delete button styling override
        function forceDeleteButtonStyling() {
            setTimeout(() => {
                const deleteButtons = document.querySelectorAll('.btn-delete');
                deleteButtons.forEach(btn => {
                    btn.style.cssText = 'background: #3b82f6 !important; color: white !important; border: none !important; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;';
                });
            }, 100);
        }

        // Initialize app
        load();
        showTab('home');
        updateStats();
        forceDeleteButtonStyling();
    </script>
</body>
</html>
