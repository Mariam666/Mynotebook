<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Notebook</title>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'EB Garamond', 'Adobe Garamond Pro', 'Garamond', 'Times New Roman', serif; 
            padding: 10px; 
            background: #f9fafb; 
            margin: 0; 
        }
        .container { max-width: 1000px; margin: 0 auto; }
        h1 { color: #333; margin-bottom: 15px; font-size: 1.5rem; }
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-card { 
            background: white; 
            padding: 12px; 
            border-radius: 8px; 
            border: 2px solid #e5e7eb; 
            text-align: center; 
            cursor: pointer; 
            font-size: 14px; 
            transition: background-color 0.2s;
        }
        .stat-card:hover { background: #f3f4f6; }
        .nav-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px; }
        .tab-btn { 
            padding: 12px 8px; 
            border: 2px solid #e5e7eb; 
            background: white; 
            border-radius: 8px; 
            cursor: pointer; 
            text-align: center; 
            font-size: 12px; 
            transition: all 0.2s;
        }
        .tab-btn:hover { background: #f3f4f6; }
        .tab-btn.active { background: #dbeafe; color: #1d4ed8; border-color: #93c5fd; }
        .content { background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; }
        .hidden { display: none; }
        input, textarea, select { 
            padding: 6px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            font-family: inherit; 
            font-size: 14px; 
        }
        textarea { width: 100%; height: 80px; resize: vertical; box-sizing: border-box; }
        .btn { 
            padding: 6px 12px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: 500; 
            font-size: 14px; 
            transition: opacity 0.2s;
        }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-green { background: #10b981; color: white; }
        .btn-delete { background: #ef4444; color: white; padding: 4px 8px; font-size: 12px; }
        .item { 
            padding: 12px; 
            border: 1px solid #e5e7eb; 
            border-radius: 6px; 
            margin-bottom: 8px; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            background: white;
        }
        .item-content { flex: 1; cursor: pointer; font-size: 14px; }
        .item-actions { display: flex; gap: 6px; align-items: center; }
        .form-row { 
            display: flex; 
            gap: 6px; 
            margin-bottom: 12px; 
            flex-wrap: wrap; 
            align-items: center; 
        }
        .form-row input, .form-row select { min-width: 80px; flex: 1; }
        
        /* Enhanced table styles for calorie tracking */
        .calorie-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        .calorie-table th, .calorie-table td { 
            border: 1px solid #e5e7eb; 
            padding: 8px 12px; 
            text-align: center; 
            font-size: 14px;
        }
        .calorie-table th { 
            background: #f3f4f6; 
            font-weight: 600; 
            color: #374151;
        }
        .calorie-table tr:nth-child(even) { background: #f9fafb; }
        .calorie-table tr:hover { background: #f3f4f6; }
        .editable-cell { 
            cursor: pointer; 
            min-width: 80px;
            position: relative;
        }
        .editable-cell:hover { background: #e0f2fe; }
        .editing { background: #fff3cd !important; }
        .net-positive { color: #dc2626; font-weight: 600; }
        .net-negative { color: #059669; font-weight: 600; }
        .net-neutral { color: #6b7280; }
        
        .week-summary { 
            background: #f8fafc; 
            border: 2px solid #e2e8f0; 
            border-radius: 8px; 
            padding: 12px; 
            margin: 15px 0;
        }
        .week-header { 
            font-weight: 600; 
            color: #1e40af; 
            margin-bottom: 8px;
            font-size: 16px;
        }
        .week-stats { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
            gap: 8px;
        }
        .week-stat { 
            text-align: center; 
            padding: 6px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e5e7eb;
        }
        .week-stat-label { 
            font-size: 12px; 
            color: #6b7280; 
            margin-bottom: 2px;
        }
        .week-stat-value { 
            font-size: 14px; 
            font-weight: 600;
        }
        .progress-indicator { 
            font-size: 18px; 
            margin-left: 8px;
        }
        
        .spending-category { 
            background: #f0f9ff; 
            border: 1px solid #bae6fd; 
            padding: 8px; 
            border-radius: 4px; 
            margin: 4px 0; 
        }
        .spending-category-header { 
            font-weight: 600; 
            color: #0369a1; 
            margin-bottom: 4px; 
        }
        
        .note-item { 
            background: #fefce8; 
            border: 1px solid #fef3c7; 
            padding: 12px; 
            border-radius: 6px; 
            margin-bottom: 8px; 
        }
        .note-date { 
            font-size: 12px; 
            color: #92400e; 
            margin-bottom: 4px; 
        }
        .note-content { 
            white-space: pre-wrap; 
            line-height: 1.5; 
        }
        
        @media (max-width: 768px) {
            body { padding: 8px; font-size: 16px; }
            .container { max-width: 100%; padding: 0; }
            h1 { font-size: 1.4rem; margin-bottom: 12px; text-align: center; font-weight: bold; }
            .stats { gap: 8px; margin-bottom: 16px; }
            .stat-card { padding: 16px; font-size: 14px; line-height: 1.3; min-height: 80px; }
            .nav-grid { gap: 6px; margin-bottom: 16px; }
            .tab-btn { padding: 20px 8px; font-size: 13px; line-height: 1.3; min-height: 70px; border-radius: 12px; }
            #home-button .tab-btn { padding: 24px; font-size: 16px; min-height: 80px; }
            .content { padding: 12px; }
            .item { padding: 12px; gap: 8px; margin-bottom: 8px; }
            .item-content { font-size: 14px; line-height: 1.4; }
            .form-row { gap: 8px; margin-bottom: 12px; flex-direction: column; align-items: stretch; }
            .form-row input, .form-row select { 
                min-width: auto; 
                font-size: 14px; 
                width: 100%; 
                margin-bottom: 6px; 
                padding: 12px; 
                box-sizing: border-box; 
            }
            .btn { padding: 12px 16px; font-size: 14px; }
            .btn-delete { padding: 8px 12px; font-size: 12px; width: auto; }
            .form-row .btn { width: 100%; padding: 14px; }
            textarea { height: 80px; font-size: 14px; padding: 12px; }
            input, textarea, select { padding: 12px; font-size: 14px; border-radius: 8px; box-sizing: border-box; }
            h2 { font-size: 1.3rem; margin-bottom: 12px; }
            h3 { font-size: 1.1rem; margin-bottom: 8px; }
            
            /* Mobile table adjustments */
            .calorie-table { font-size: 12px; }
            .calorie-table th, .calorie-table td { padding: 6px 4px; }
            .week-stats { grid-template-columns: repeat(2, 1fr); }
            .week-stat { padding: 8px 4px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìù Notebook</h1>
        
        <div id="stats" class="stats">
            <div class="stat-card" onclick="showTab('calories')">
                <div>üî• Calories</div>
                <div style="font-size: 14px; color: #2563eb;" id="cal-today">0 cal today</div>
                <div style="font-size: 14px; color: #8b5cf6;" id="protein-today">0g protein</div>
                <div style="font-size: 14px; color: #f59e0b;" id="balance-today">Enter burned calories</div>
            </div>
            <div class="stat-card" onclick="showTab('spending')">
                <div>üí∞ Spending</div>
                <div style="font-size: 14px; color: #dc2626;" id="spend-today">$0 today</div>
                <div style="font-size: 14px; color: #2563eb;" id="spend-week">$0 this week</div>
                <div style="font-size: 14px; color: #8b5cf6;" id="spend-month">$0 this month</div>
            </div>
        </div>
        
        <div id="home-button" style="margin-bottom: 15px;">
            <button class="tab-btn active" onclick="showTab('home')" id="tab-home" style="width: 100%; padding: 20px;">
                üè† Home
            </button>
        </div>
        
        <div class="nav-grid" id="nav-grid">
            <button class="tab-btn" onclick="showTab('notes')" id="tab-notes">üìù<br>Notes</button>
            <button class="tab-btn" onclick="showTab('read')" id="tab-read">üìö<br>Read</button>
            <button class="tab-btn" onclick="showTab('listen')" id="tab-listen">üéµ<br>Listen</button>
            <button class="tab-btn" onclick="showTab('watch')" id="tab-watch">üì∫<br>Watch</button>
            <button class="tab-btn" onclick="showTab('look')" id="tab-look">üëÅÔ∏è<br>Look</button>
            <button class="tab-btn" onclick="showTab('cook')" id="tab-cook">üç≥<br>Cook</button>
            <button class="tab-btn" onclick="showTab('make')" id="tab-make">üî®<br>Make</button>
            <button class="tab-btn" onclick="showTab('calories')" id="tab-calories">üî•<br>Calories</button>
            <button class="tab-btn" onclick="showTab('spending')" id="tab-spending">üí∞<br>Spending</button>
        </div>

        <div style="text-align: center; margin-bottom: 20px;">
            <button class="btn btn-green" onclick="downloadData()">üì• Download Data</button>
            <button class="btn" onclick="document.getElementById('upload').click()" style="background: #8b5cf6; color: white;">üì§ Upload Data</button>
            <input type="file" id="upload" accept=".json" style="display: none;" onchange="uploadData(event)">
        </div>
        
        <div id="content" class="content hidden"></div>
    </div>

    <script>
        let data = {
            lists: { read: [], listen: [], watch: [], cook: [], make: [], look: [] },
            notes: [],
            calories: [],
            caloriesBurned: [],
            spending: [],
            calorieTable: [],
            customCalorieDays: []
        };

        function getPSTDate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function save() {
            try {
                localStorage.setItem('notebookData', JSON.stringify(data));
            } catch (e) {
                console.error('Save error:', e);
                alert('Error saving data: ' + e.message);
            }
        }

        function load() {
            try {
                const saved = localStorage.getItem('notebookData');
                if (saved) {
                    const loadedData = JSON.parse(saved);
                    data = { ...data, ...loadedData };
                    
                    // Clean up data structure - ensure lists contain valid items
                    if (data.lists) {
                        Object.keys(data.lists).forEach(listName => {
                            if (Array.isArray(data.lists[listName])) {
                                data.lists[listName] = data.lists[listName].filter(item => 
                                    item && typeof item === 'object' && item.title
                                );
                            } else {
                                data.lists[listName] = [];
                            }
                        });
                    }
                    
                    // Ensure other arrays exist and are valid
                    if (!Array.isArray(data.calories)) data.calories = [];
                    if (!Array.isArray(data.caloriesBurned)) data.caloriesBurned = [];
                    if (!Array.isArray(data.spending)) data.spending = [];
                    if (!Array.isArray(data.notes)) data.notes = [];
                    if (!data.calorieTable) data.calorieTable = [];
                }
            } catch (e) {
                console.error('Load error:', e);
                alert('Error loading data: ' + e.message);
            }
        }

        function showTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            if (tab === 'home') {
                document.getElementById('stats').style.display = 'grid';
                document.getElementById('content').classList.add('hidden');
                document.getElementById('tab-home').classList.add('active');
                updateStats();
            } else {
                document.getElementById('stats').style.display = 'none';
                document.getElementById('content').classList.remove('hidden');
                document.getElementById('tab-' + tab).classList.add('active');
                loadTab(tab);
            }
        }

        function loadTab(tab) {
            if (['read', 'listen', 'watch', 'cook', 'make', 'look'].includes(tab)) {
                loadListTab(tab);
            } else if (tab === 'notes') {
                loadNotesTab();
            } else if (tab === 'calories') {
                loadCaloriesTab();
            } else if (tab === 'spending') {
                loadSpendingTab();
            }
        }

        function loadListTab(listName) {
            const items = data.lists[listName] || [];
            const content = document.getElementById('content');
            
            let html = '<h2>' + listName.toUpperCase() + '</h2>';
            
            if (listName === 'read') {
                html += '<div class="form-row">' +
                        '<input type="text" id="item-input" placeholder="Title" style="flex: 2;">' +
                        '<input type="url" id="link-input" placeholder="Link">' +
                        '<select id="cat-input"><option value="book">Book</option><option value="essay">Essay</option><option value="poem">Poem</option></select>' +
                        '<input type="date" id="date-input" value="' + getPSTDate() + '">' +
                        '<button class="btn btn-primary" onclick="addItem(\'' + listName + '\')">Add</button>' +
                        '</div>';
            } else {
                html += '<div class="form-row">' +
                        '<input type="text" id="item-input" placeholder="Title" style="flex: 2;">' +
                        '<input type="url" id="link-input" placeholder="Link">' +
                        '<input type="date" id="date-input" value="' + getPSTDate() + '">' +
                        '<button class="btn btn-primary" onclick="addItem(\'' + listName + '\')">Add</button>' +
                        '</div>';
            }
            
            html += '<div style="margin: 8px 0;"><input type="text" id="search-' + listName + '" placeholder="üîç Search..." style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" oninput="filterItems(\'' + listName + '\')"></div>';
            
            html += '<div id="items-' + listName + '">';
            items.forEach((item, i) => {
                const progressIndicator = item.completed ? '‚úÖ' : '‚è≥';
                const itemStyle = item.completed ? 'text-decoration: line-through; opacity: 0.7;' : '';
                
                // Get category color for reading items
                let category = '';
                if (item.category) {
                    const categoryColors = {
                        book: { bg: '#dbeafe', color: '#1d4ed8' },      // blue
                        essay: { bg: '#fef3c7', color: '#92400e' },     // yellow/amber  
                        poem: { bg: '#fce7f3', color: '#be185d' }       // pink
                    };
                    const colors = categoryColors[item.category] || { bg: '#dbeafe', color: '#1d4ed8' };
                    category = ` <span style="background: ${colors.bg}; color: ${colors.color}; padding: 2px 6px; border-radius: 3px; font-size: 11px;">${item.category}</span>`;
                }
                
                html += `<div class="item item-${listName}-${i}">
                    <div class="item-content" style="${itemStyle}" onclick="toggleComplete('${listName}', ${i})">${progressIndicator} ${item.title}${category} ${item.link ? '<a href="' + item.link + '" target="_blank" style="color: #2563eb;">üîó</a>' : ''} <small style="color: #666;">(${item.date})</small></div>
                    <div class="item-actions">
                        <button class="btn-delete" onclick="deleteItem('${listName}', ${i})">üóëÔ∏è</button>
                    </div>
                </div>`;
            });
            html += '</div>';
            
            content.innerHTML = html;
        }

        function filterItems(listName) {
            const searchTerm = document.getElementById('search-' + listName).value.toLowerCase();
            const items = data.lists[listName] || [];
            
            document.querySelectorAll(`.item-${listName}-`).forEach(element => {
                element.style.display = 'none';
            });
            
            items.forEach((item, i) => {
                if (item.title.toLowerCase().includes(searchTerm) || 
                    (item.category && item.category.toLowerCase().includes(searchTerm))) {
                    const element = document.querySelector(`.item-${listName}-${i}`);
                    if (element) element.style.display = 'flex';
                }
            });
        }

        function loadNotesTab() {
            const content = document.getElementById('content');
            let html = '<h2>NOTES</h2>';
            
            html += '<div class="form-row">' +
                    '<textarea id="note-input" placeholder="Write your note here..." style="flex: 1; margin-right: 8px;"></textarea>' +
                    '<button class="btn btn-primary" onclick="addNote()">Add Note</button>' +
                    '</div>';
                    
            html += '<div>';
            data.notes.forEach((note, i) => {
                html += `<div class="note-item">
                    <div class="note-date">${note.date}</div>
                    <div class="note-content">${note.content}</div>
                    <button class="btn-delete" onclick="deleteNote(${i})" style="margin-top: 8px;">üóëÔ∏è Delete</button>
                </div>`;
            });
            html += '</div>';
            
            content.innerHTML = html;
        }

        // Global variable to store current calorie view week
        let currentCalorieWeek = new Date();

        function loadCaloriesTab() {
            const content = document.getElementById('content');
            let html = '<h2>CALORIE TRACKING</h2>';
            
            // Simple calorie entry form
            html += '<div class="form-row">' +
                    '<input type="text" id="food-input" placeholder="Food item" style="flex: 2;">' +
                    '<input type="number" id="calories-input" placeholder="Calories" min="0">' +
                    '<input type="number" id="protein-input" placeholder="Protein (g)" min="0" step="0.1">' +
                    '<input type="date" id="cal-date-input" value="' + getPSTDate() + '">' +
                    '<button class="btn btn-primary" onclick="addCalorie()">Add</button>' +
                    '</div>';
                    
            // Calories burned form
            html += '<div class="form-row">' +
                    '<input type="text" id="exercise-input" placeholder="Exercise/Activity" style="flex: 2;">' +
                    '<input type="number" id="burned-input" placeholder="Calories burned" min="0">' +
                    '<input type="date" id="burned-date-input" value="' + getPSTDate() + '">' +
                    '<button class="btn btn-green" onclick="addCalorieBurned()">Add Burned</button>' +
                    '</div>';

            // Week navigation
            html += '<div style="display: flex; align-items: center; justify-content: space-between; margin: 15px 0; background: #f8fafc; padding: 10px; border-radius: 8px;">';
            html += '<button class="btn" onclick="changeCalorieWeek(-1)" style="background: #6b7280; color: white;">‚Üê Previous Week</button>';
            html += '<div style="text-align: center; font-weight: 600; color: #374151;">' + formatWeekHeader(currentCalorieWeek) + '</div>';
            html += '<button class="btn" onclick="changeCalorieWeek(1)" style="background: #6b7280; color: white;">Next Week ‚Üí</button>';
            html += '</div>';
            
            // Add day and fill missing day buttons
            html += '<div style="text-align: center; margin: 15px 0; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">';
            html += '<button class="btn" onclick="addDay()" style="background: #8b5cf6; color: white;">üìÖ Add Day</button>';
            html += '<button class="btn" onclick="fillMissingDays()" style="background: #f59e0b; color: white;">üîÑ Fill Missing Days</button>';
            html += '<button class="btn" onclick="goToToday()" style="background: #10b981; color: white;">üè† Today</button>';
            html += '</div>';

            // Enhanced calorie table
            html += '<h3>Weekly Calorie Overview</h3>';
            html += generateCalorieTable();
            
            // Recent entries
            html += '<h3>Recent Entries</h3>';
            html += '<div>';
            const allEntries = [
                ...data.calories.map(c => ({...c, type: 'consumed'})),
                ...data.caloriesBurned.map(c => ({...c, type: 'burned'}))
            ].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10);
            
            allEntries.forEach((entry, i) => {
                const isConsumed = entry.type === 'consumed';
                const icon = isConsumed ? 'üçΩÔ∏è' : 'üèÉ';
                const color = isConsumed ? '#059669' : '#dc2626';
                const proteinText = isConsumed && entry.protein ? ` (${entry.protein}g protein)` : '';
                html += `<div class="item">
                    <div class="item-content">${icon} ${entry.food || entry.exercise} - <span style="color: ${color};">${isConsumed ? '+' : '-'}${entry.calories} cal</span>${proteinText} <small style="color: #666;">(${entry.date})</small></div>
                    <div class="item-actions">
                        <button class="btn-delete" onclick="deleteCalorieEntry('${entry.type}', '${entry.date}', '${entry.food || entry.exercise}')">üóëÔ∏è</button>
                    </div>
                </div>`;
            });
            html += '</div>';
            
            content.innerHTML = html;
        }

        function formatWeekHeader(date) {
            const startOfWeek = new Date(date);
            startOfWeek.setDate(date.getDate() - date.getDay());
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            
            const options = { month: 'short', day: 'numeric' };
            return `${startOfWeek.toLocaleDateString('en-US', options)} - ${endOfWeek.toLocaleDateString('en-US', options)}`;
        }

        function changeCalorieWeek(direction) {
            const newDate = new Date(currentCalorieWeek);
            newDate.setDate(currentCalorieWeek.getDate() + (direction * 7));
            currentCalorieWeek = newDate;
            loadCaloriesTab();
        }

        function addDay() {
            // Simply add tomorrow's date
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const dateToAdd = tomorrow.toISOString().split('T')[0];
            
            // Initialize customCalorieDays if it doesn't exist
            if (!data.customCalorieDays) {
                data.customCalorieDays = [];
            }
            
            // Add the date if not already present
            if (!data.customCalorieDays.includes(dateToAdd)) {
                data.customCalorieDays.push(dateToAdd);
                save();
            }
            
            // Navigate to show this week
            currentCalorieWeek = tomorrow;
            loadCaloriesTab();
        }

        function fillMissingDays() {
            if (!data.calories.length && !data.caloriesBurned.length) {
                alert('No calorie data found. Add some entries first.');
                return;
            }
            
            // Find the earliest and latest dates in the data
            const allDates = [
                ...data.calories.map(c => c.date),
                ...data.caloriesBurned.map(c => c.date)
            ].filter(date => date).sort();
            
            if (allDates.length === 0) {
                alert('No dates found in calorie data.');
                return;
            }
            
            const startDate = new Date(allDates[0]);
            const endDate = new Date(allDates[allDates.length - 1]);
            const today = new Date(getPSTDate());
            
            // Extend to today if needed
            if (endDate < today) {
                endDate.setTime(today.getTime());
            }
            
            const existingDates = new Set(allDates);
            const missingDates = [];
            
            // Find missing dates between start and end
            const currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                const dateStr = currentDate.toISOString().split('T')[0];
                if (!existingDates.has(dateStr)) {
                    missingDates.push(dateStr);
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            if (missingDates.length === 0) {
                alert('No missing days found. Your calendar is complete!');
                return;
            }
            
            const confirm = window.confirm(`Found ${missingDates.length} missing days between ${allDates[0]} and ${endDate.toISOString().split('T')[0]}. Fill them with zero entries?`);
            
            if (confirm) {
                missingDates.forEach(date => {
                    // Add zero calorie placeholder entries
                    data.calories.push({
                        date: date,
                        food: 'No entries',
                        calories: '0',
                        protein: '0'
                    });
                });
                
                save();
                loadCaloriesTab();
                alert(`Added ${missingDates.length} missing days to your calendar.`);
            }
        }

        function goToToday() {
            currentCalorieWeek = new Date();
            loadCaloriesTab();
        }

        function generateCalorieTable() {
            const viewWeek = [];
            
            // Get the week being viewed (Sunday to Saturday)
            const startOfWeek = new Date(currentCalorieWeek);
            startOfWeek.setDate(currentCalorieWeek.getDate() - currentCalorieWeek.getDay());
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);
                viewWeek.push(date.toISOString().split('T')[0]);
            }
            
            // Add any custom tracked days for this week
            if (data.customCalorieDays) {
                data.customCalorieDays.forEach(customDate => {
                    const customDateObj = new Date(customDate);
                    if (customDateObj >= startOfWeek && customDateObj < new Date(startOfWeek.getTime() + 7 * 24 * 60 * 60 * 1000)) {
                        if (!viewWeek.includes(customDate)) {
                            viewWeek.push(customDate);
                        }
                    }
                });
            }
            
            // Sort dates to display in order
            viewWeek.sort();
            
            let html = '<table class="calorie-table">';
            html += '<thead><tr><th>Day</th><th>Consumed</th><th>Burned</th><th>Net</th><th>Protein</th></tr></thead><tbody>';
            
            viewWeek.forEach(dateStr => {
                const dayName = new Date(dateStr).toLocaleDateString('en-US', { weekday: 'short' });
                const consumed = data.calories.filter(c => c.date === dateStr).reduce((sum, c) => sum + parseInt(c.calories || 0), 0);
                const burned = data.caloriesBurned.filter(c => c.date === dateStr).reduce((sum, c) => sum + parseInt(c.calories || 0), 0);
                const protein = data.calories.filter(c => c.date === dateStr).reduce((sum, c) => sum + parseFloat(c.protein || 0), 0);
                const net = consumed - burned;
                
                const netClass = net > 0 ? 'net-positive' : net < 0 ? 'net-negative' : 'net-neutral';
                const isToday = dateStr === getPSTDate() ? ' style="background: #fef3c7;"' : '';
                
                html += `<tr${isToday}>
                    <td><strong>${dayName}</strong><br><small>${dateStr}</small></td>
                    <td class="editable-cell" onclick="editCell(this, 'consumed', '${dateStr}')">${consumed}</td>
                    <td class="editable-cell" onclick="editCell(this, 'burned', '${dateStr}')">${burned}</td>
                    <td class="${netClass}">${net > 0 ? '+' : ''}${net}</td>
                    <td>${protein.toFixed(1)}g</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            
            // Week summary
            const weekConsumed = viewWeek.reduce((sum, date) => {
                return sum + data.calories.filter(c => c.date === date).reduce((daySum, c) => daySum + parseInt(c.calories || 0), 0);
            }, 0);
            const weekBurned = viewWeek.reduce((sum, date) => {
                return sum + data.caloriesBurned.filter(c => c.date === date).reduce((daySum, c) => daySum + parseInt(c.calories || 0), 0);
            }, 0);
            const weekProtein = viewWeek.reduce((sum, date) => {
                return sum + data.calories.filter(c => c.date === date).reduce((daySum, c) => daySum + parseFloat(c.protein || 0), 0);
            }, 0);
            const weekNet = weekConsumed - weekBurned;
            
            html += '<div class="week-summary">';
            html += '<div class="week-header">üìä This Week Summary</div>';
            html += '<div class="week-stats">';
            html += `<div class="week-stat"><div class="week-stat-label">Consumed</div><div class="week-stat-value" style="color: #059669;">+${weekConsumed}</div></div>`;
            html += `<div class="week-stat"><div class="week-stat-label">Burned</div><div class="week-stat-value" style="color: #dc2626;">-${weekBurned}</div></div>`;
            html += `<div class="week-stat"><div class="week-stat-label">Net</div><div class="week-stat-value ${weekNet > 0 ? 'net-positive' : weekNet < 0 ? 'net-negative' : 'net-neutral'}">${weekNet > 0 ? '+' : ''}${weekNet}</div></div>`;
            html += `<div class="week-stat"><div class="week-stat-label">Protein</div><div class="week-stat-value" style="color: #8b5cf6;">${weekProtein.toFixed(1)}g</div></div>`;
            html += '</div></div>';
            
            return html;
        }

        function loadSpendingTab() {
            const content = document.getElementById('content');
            let html = '<h2>SPENDING TRACKER</h2>';
            
            html += '<div class="form-row">' +
                    '<input type="text" id="spend-desc" placeholder="Description" style="flex: 2;">' +
                    '<input type="number" id="spend-amount" placeholder="Amount" min="0" step="0.01">' +
                    '<select id="spend-category">' +
                    '<option value="food">Food</option>' +
                    '<option value="transport">Transport</option>' +
                    '<option value="entertainment">Entertainment</option>' +
                    '<option value="shopping">Shopping</option>' +
                    '<option value="bills">Bills</option>' +
                    '<option value="subscription">Subscription</option>' +
                    '<option value="health">Health</option>' +
                    '<option value="other">Other</option>' +
                    '</select>' +
                    '<input type="date" id="spend-date" value="' + getPSTDate() + '">' +
                    '<button class="btn btn-primary" onclick="addSpending()">Add</button>' +
                    '</div>';
                    
            // Spending analytics
            html += generateSpendingAnalytics();
            
            // Recent spending
            html += '<h3>Recent Spending</h3>';
            html += '<div>';
            const sortedSpending = [...data.spending].sort((a, b) => new Date(b.date) - new Date(a.date));
            sortedSpending.slice(0, 15).forEach((spend, i) => {
                const categoryColor = getCategoryColor(spend.category);
                html += `<div class="item">
                    <div class="item-content">üí∞ ${spend.description} - <span style="color: #dc2626; font-weight: 600;">$${parseFloat(spend.amount).toFixed(2)}</span> 
                        <span style="background: ${categoryColor}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px;">${spend.category}</span>
                        <small style="color: #666;"> (${spend.date})</small>
                    </div>
                    <div class="item-actions">
                        <button class="btn-delete" onclick="deleteSpending(${data.spending.findIndex(s => s === spend)})">üóëÔ∏è</button>
                    </div>
                </div>`;
            });
            html += '</div>';
            
            content.innerHTML = html;
        }

        function generateSpendingAnalytics() {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            // This week
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay());
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            
            // This month
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            const todaySpending = data.spending.filter(s => s.date === todayStr).reduce((sum, s) => sum + parseFloat(s.amount), 0);
            const weekSpending = data.spending.filter(s => {
                const spendDate = new Date(s.date);
                return spendDate >= startOfWeek && spendDate <= endOfWeek;
            }).reduce((sum, s) => sum + parseFloat(s.amount), 0);
            const monthSpending = data.spending.filter(s => {
                const spendDate = new Date(s.date);
                return spendDate >= startOfMonth && spendDate <= endOfMonth;
            }).reduce((sum, s) => sum + parseFloat(s.amount), 0);
            
            // Category breakdown for this month
            const categoryTotals = {};
            data.spending.filter(s => {
                const spendDate = new Date(s.date);
                return spendDate >= startOfMonth && spendDate <= endOfMonth;
            }).forEach(spend => {
                categoryTotals[spend.category] = (categoryTotals[spend.category] || 0) + parseFloat(spend.amount);
            });
            
            let html = '<div class="week-summary">';
            html += '<div class="week-header">üìä Spending Analytics</div>';
            html += '<div class="week-stats">';
            html += `<div class="week-stat"><div class="week-stat-label">Today</div><div class="week-stat-value" style="color: #dc2626;">$${todaySpending.toFixed(2)}</div></div>`;
            html += `<div class="week-stat"><div class="week-stat-label">This Week</div><div class="week-stat-value" style="color: #dc2626;">$${weekSpending.toFixed(2)}</div></div>`;
            html += `<div class="week-stat"><div class="week-stat-label">This Month</div><div class="week-stat-value" style="color: #dc2626;">$${monthSpending.toFixed(2)}</div></div>`;
            html += '</div>';
            
            // Subscription tracking
            const subscriptions = data.spending.filter(s => s.category === 'subscription');
            const monthlySubscriptions = subscriptions.filter(s => {
                const spendDate = new Date(s.date);
                return spendDate >= startOfMonth && spendDate <= endOfMonth;
            });
            const subscriptionTotal = monthlySubscriptions.reduce((sum, s) => sum + parseFloat(s.amount), 0);
            
            if (subscriptions.length > 0) {
                html += '<div style="margin-top: 12px;"><strong>üì± Subscriptions This Month: $' + subscriptionTotal.toFixed(2) + '</strong></div>';
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; margin-top: 8px;">';
                monthlySubscriptions.forEach(sub => {
                    html += `<div style="background: #fef3c7; border: 1px solid #f59e0b; padding: 8px; border-radius: 4px;">
                        <div style="font-weight: 600; color: #92400e;">${sub.description}</div>
                        <div style="color: #dc2626;">$${parseFloat(sub.amount).toFixed(2)}</div>
                        <div style="font-size: 12px; color: #6b7280;">${sub.date}</div>
                    </div>`;
                });
                html += '</div>';
            }
            
            // Category breakdown
            if (Object.keys(categoryTotals).length > 0) {
                html += '<div style="margin-top: 12px;"><strong>This Month by Category:</strong></div>';
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 8px; margin-top: 8px;">';
                Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]).forEach(([category, amount]) => {
                    const color = getCategoryColor(category);
                    html += `<div class="spending-category">
                        <div class="spending-category-header" style="color: ${color};">${category.charAt(0).toUpperCase() + category.slice(1)}</div>
                        <div style="font-weight: 600;">$${amount.toFixed(2)}</div>
                    </div>`;
                });
                html += '</div>';
            }
            
            html += '</div>';
            return html;
        }

        function getCategoryColor(category) {
            const colors = {
                food: '#f59e0b',
                transport: '#3b82f6',
                entertainment: '#8b5cf6',
                shopping: '#ec4899',
                bills: '#ef4444',
                subscription: '#06b6d4',
                health: '#10b981',
                other: '#6b7280'
            };
            return colors[category] || '#6b7280';
        }

        function addItem(listName) {
            const title = document.getElementById('item-input').value.trim();
            const link = document.getElementById('link-input').value.trim();
            const date = document.getElementById('date-input').value;
            const category = document.getElementById('cat-input') ? document.getElementById('cat-input').value : null;
            
            if (!title) {
                alert('Please enter a title');
                return;
            }
            
            const item = { title, link, date, completed: false };
            if (category) item.category = category;
            
            data.lists[listName].push(item);
            save();
            loadListTab(listName);
            
            // Clear inputs
            document.getElementById('item-input').value = '';
            document.getElementById('link-input').value = '';
            document.getElementById('date-input').value = getPSTDate();
            if (document.getElementById('cat-input')) {
                document.getElementById('cat-input').value = 'book';
            }
        }

        function deleteItem(listName, index) {
            if (confirm('Delete this item?')) {
                data.lists[listName].splice(index, 1);
                save();
                loadListTab(listName);
            }
        }

        function toggleComplete(listName, index) {
            data.lists[listName][index].completed = !data.lists[listName][index].completed;
            save();
            loadListTab(listName);
        }

        function addNote() {
            const content = document.getElementById('note-input').value.trim();
            if (!content) {
                alert('Please enter a note');
                return;
            }
            
            data.notes.push({
                content: content,
                date: getPSTDate()
            });
            save();
            loadNotesTab();
            
            // Clear input
            document.getElementById('note-input').value = '';
        }

        function deleteNote(index) {
            if (confirm('Delete this note?')) {
                data.notes.splice(index, 1);
                save();
                loadNotesTab();
            }
        }

        function addCalorie() {
            const food = document.getElementById('food-input').value.trim();
            const calories = document.getElementById('calories-input').value;
            const protein = document.getElementById('protein-input').value || '0';
            const date = document.getElementById('cal-date-input').value;
            
            if (!food || !calories) {
                alert('Please enter food and calories');
                return;
            }
            
            data.calories.push({ food, calories, protein, date });
            save();
            loadCaloriesTab();
            updateStats();
            
            // Clear inputs
            document.getElementById('food-input').value = '';
            document.getElementById('calories-input').value = '';
            document.getElementById('protein-input').value = '';
            document.getElementById('cal-date-input').value = getPSTDate();
        }

        function addCalorieBurned() {
            const exercise = document.getElementById('exercise-input').value.trim();
            const calories = document.getElementById('burned-input').value;
            const date = document.getElementById('burned-date-input').value;
            
            if (!exercise || !calories) {
                alert('Please enter exercise and calories burned');
                return;
            }
            
            data.caloriesBurned.push({ exercise, calories, date });
            save();
            loadCaloriesTab();
            updateStats();
            
            // Clear inputs
            document.getElementById('exercise-input').value = '';
            document.getElementById('burned-input').value = '';
            document.getElementById('burned-date-input').value = getPSTDate();
        }

        function deleteCalorieEntry(type, date, name) {
            if (confirm('Delete this entry?')) {
                if (type === 'consumed') {
                    const index = data.calories.findIndex(c => c.date === date && c.food === name);
                    if (index !== -1) {
                        data.calories.splice(index, 1);
                    }
                } else {
                    const index = data.caloriesBurned.findIndex(c => c.date === date && c.exercise === name);
                    if (index !== -1) {
                        data.caloriesBurned.splice(index, 1);
                    }
                }
                save();
                loadCaloriesTab();
                updateStats();
            }
        }

        function editCell(cell, type, date) {
            if (cell.classList.contains('editing')) return;
            
            const currentValue = cell.textContent;
            const input = document.createElement('input');
            input.type = 'number';
            input.value = currentValue;
            input.style.width = '80px';
            input.style.border = 'none';
            input.style.background = 'transparent';
            input.style.textAlign = 'center';
            
            cell.classList.add('editing');
            cell.textContent = '';
            cell.appendChild(input);
            input.focus();
            input.select();
            
            function saveEdit() {
                const newValue = parseInt(input.value) || 0;
                cell.classList.remove('editing');
                cell.textContent = newValue;
                
                // Update the data
                if (type === 'consumed') {
                    // Find or create calorie entry for this date
                    let entry = data.calories.find(c => c.date === date);
                    if (!entry) {
                        entry = { date, food: 'Quick edit', calories: '0', protein: '0' };
                        data.calories.push(entry);
                    }
                    entry.calories = newValue.toString();
                } else if (type === 'burned') {
                    // Find or create burned entry for this date
                    let entry = data.caloriesBurned.find(c => c.date === date);
                    if (!entry) {
                        entry = { date, exercise: 'Quick edit', calories: '0' };
                        data.caloriesBurned.push(entry);
                    }
                    entry.calories = newValue.toString();
                }
                
                save();
                loadCaloriesTab(); // Refresh to recalculate totals
                updateStats();
            }
            
            input.onblur = saveEdit;
            input.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    saveEdit();
                }
            };
        }

        function addSpending() {
            const description = document.getElementById('spend-desc').value.trim();
            const amount = document.getElementById('spend-amount').value;
            const category = document.getElementById('spend-category').value;
            const date = document.getElementById('spend-date').value;
            
            if (!description || !amount) {
                alert('Please enter description and amount');
                return;
            }
            
            data.spending.push({ description, amount, category, date });
            save();
            loadSpendingTab();
            updateStats();
            
            // Clear inputs
            document.getElementById('spend-desc').value = '';
            document.getElementById('spend-amount').value = '';
            document.getElementById('spend-category').value = 'food';
            document.getElementById('spend-date').value = getPSTDate();
        }

        function deleteSpending(index) {
            if (confirm('Delete this spending entry?')) {
                data.spending.splice(index, 1);
                save();
                loadSpendingTab();
                updateStats();
            }
        }

        function updateStats() {
            const today = getPSTDate();
            
            // Calorie stats
            const todayConsumed = data.calories.filter(c => c.date === today).reduce((sum, c) => sum + parseInt(c.calories || 0), 0);
            const todayBurned = data.caloriesBurned.filter(c => c.date === today).reduce((sum, c) => sum + parseInt(c.calories || 0), 0);
            const todayProtein = data.calories.filter(c => c.date === today).reduce((sum, c) => sum + parseFloat(c.protein || 0), 0);
            const netCalories = todayConsumed - todayBurned;
            
            document.getElementById('cal-today').textContent = `${todayConsumed} cal today`;
            document.getElementById('protein-today').textContent = `${todayProtein.toFixed(1)}g protein`;
            
            if (todayBurned > 0) {
                const balanceColor = netCalories > 0 ? '#dc2626' : '#059669'; // red for surplus, green for deficit
                document.getElementById('balance-today').innerHTML = `<span style="color: ${balanceColor};">${netCalories > 0 ? '+' : ''}${netCalories} net cal</span>`;
            } else {
                document.getElementById('balance-today').textContent = 'Enter burned calories';
            }
            
            // Spending stats
            const todaySpending = data.spending.filter(s => s.date === today).reduce((sum, s) => sum + parseFloat(s.amount), 0);
            
            // This week
            const startOfWeek = new Date();
            startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            
            const weekSpending = data.spending.filter(s => {
                const spendDate = new Date(s.date);
                return spendDate >= startOfWeek && spendDate <= endOfWeek;
            }).reduce((sum, s) => sum + parseFloat(s.amount), 0);
            
            // This month
            const startOfMonth = new Date();
            startOfMonth.setDate(1);
            const monthSpending = data.spending.filter(s => {
                const spendDate = new Date(s.date);
                return spendDate >= startOfMonth;
            }).reduce((sum, s) => sum + parseFloat(s.amount), 0);
            
            document.getElementById('spend-today').textContent = `$${todaySpending.toFixed(2)} today`;
            document.getElementById('spend-week').textContent = `$${weekSpending.toFixed(2)} this week`;
            document.getElementById('spend-month').textContent = `$${monthSpending.toFixed(2)} this month`;
        }

        function downloadData() {
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'notebook-data-' + getPSTDate() + '.json';
            link.click();
        }

        function uploadData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let content = e.target.result;
                    
                    // Check if it's an HTML file (from previous backups)
                    if (content.includes('<!DOCTYPE html>') || content.includes('<html>')) {
                        alert('This appears to be an HTML backup file. Please export your data as JSON from the old version and try again.');
                        return;
                    }
                    
                    // Try to parse as JSON
                    const loadedData = JSON.parse(content);
                    
                    // Validate the data structure
                    if (typeof loadedData === 'object' && loadedData !== null) {
                        // Merge with existing data structure to ensure all fields exist
                        data = {
                            lists: loadedData.lists || { read: [], listen: [], watch: [], cook: [], make: [], look: [] },
                            notes: loadedData.notes || [],
                            calories: loadedData.calories || [],
                            caloriesBurned: loadedData.caloriesBurned || [],
                            spending: loadedData.spending || [],
                            calorieTable: loadedData.calorieTable || [],
                            customCalorieDays: loadedData.customCalorieDays || []
                        };
                        
                        save();
                        updateStats();
                        alert('Data uploaded successfully!');
                        showTab('home');
                    } else {
                        throw new Error('Invalid data structure');
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    alert('Error uploading data: ' + error.message + '\nPlease check the file format.');
                }
            };
            reader.readAsText(file);
            
            // Clear the input
            event.target.value = '';
        }

        // Add function to reset corrupted data
        function resetData() {
            if (confirm('This will clear all data and reset the app. Continue?')) {
                localStorage.removeItem('notebookData');
                data = {
                    lists: { read: [], listen: [], watch: [], cook: [], make: [], look: [] },
                    notes: [],
                    calories: [],
                    caloriesBurned: [],
                    spending: [],
                    calorieTable: []
                };
                save();
                showTab('home');
                alert('Data has been reset.');
            }
        }

        // Function to inspect and recover data
        function inspectData() {
            const saved = localStorage.getItem('notebookData');
            if (saved) {
                console.log('Raw data length:', saved.length);
                console.log('Raw data preview:', saved.substring(0, 200));
                
                try {
                    const parsed = JSON.parse(saved);
                    console.log('Parsed data structure:', Object.keys(parsed));
                    console.log('Full parsed data:', parsed);
                } catch (e) {
                    console.error('Parse error:', e);
                }
            } else {
                console.log('No saved data found');
            }
        }

        // Initialize the app
        load();
        showTab('home');
    </script>
</body>
</html>
